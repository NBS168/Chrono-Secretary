<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰ç§˜æ›¸ - è‡ªå‹•åŒ–è¡Œç¨‹åŠ©ç†ç”¢ç”Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .step-number {
            width: 2rem;
            height: 2rem;
            background-color: #2563eb;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-blue-600 text-white p-6 shadow-md">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold"><i class="fa-solid fa-robot mr-2"></i>æ™‚å…‰ç§˜æ›¸ (Chrono-Secretary)</h1>
                <p class="text-blue-100 text-sm mt-1">v3.3 åš´æ ¼é˜²å‘† & å½ˆæ€§æ™‚é–“ç‰ˆ</p>
            </div>
            <div class="text-3xl opacity-20"><i class="fa-regular fa-calendar-check"></i></div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6 space-y-8">

        <!-- ç°¡ä»‹ -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘‹ v3.3 ç‰ˆæœ¬æ›´æ–°</h2>
            <p class="text-gray-600 leading-relaxed mb-4">
                é€™å€‹ç‰ˆæœ¬å¤§å¹…å¼·åŒ–äº†å°ã€ŒéŒ¯èª¤è¼¸å…¥ã€çš„åµæ¸¬èƒ½åŠ›ï¼Œä¸¦æ”¯æ´æ›´å¤šå…ƒçš„ç°¡å¯«æ™‚é–“æ ¼å¼ã€‚
            </p>
            <ul class="list-disc list-inside space-y-2 text-gray-600 ml-2">
                <li>ğŸš« <b>æ—¥æœŸé˜²å‘†ï¼š</b>è¼¸å…¥ 11/1311/20 æˆ– 22/1 (æœˆä»½éŒ¯èª¤) æœƒå›è¦†ç„¡æ³•åˆ¤æ–·ã€‚</li>
                <li>ğŸš« <b>æ™‚é–“é˜²å‘†ï¼š</b>è¼¸å…¥ 912 æˆ– 1415 (ç„¡åˆ†éš”ç¬¦) æœƒå›è¦†ç„¡æ³•åˆ¤æ–·ã€‚</li>
                <li>ğŸ•’ <b>å½ˆæ€§æ™‚é–“ï¼š</b>æ”¯æ´ 9-12 (æ•´é»)ã€13:40-15ã€0900-1200 ç­‰æ ¼å¼ã€‚</li>
                <li>ğŸ“… <b>æ°‘åœ‹å¹´æ”¯æ´ï¼š</b>è¼¸å…¥ 115å¹´ è‡ªå‹•è½‰ 2026ã€‚</li>
                <li>ğŸ›¡ï¸ <b>OCR ç©©å®šï¼š</b>åŒ…å«é‡è©¦æ©Ÿåˆ¶ã€‚</li>
            </ul>
        </section>

        <!-- æ­¥é©Ÿ 1: LINE è¨­å®š -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number">1</div>
                <h2 class="text-xl font-bold text-gray-800">å»ºç«‹ LINE å®˜æ–¹å¸³è™Ÿèˆ‡å–å¾— Token</h2>
            </div>
            
            <div class="pl-10 space-y-6 text-sm text-gray-600">
                <div>
                    <h3 class="font-bold text-blue-700 mb-2"><i class="fa-solid fa-key mr-1"></i> å–å¾— Channel Access Token</h3>
                    <ul class="list-decimal ml-5 space-y-2">
                        <li>å‰å¾€ <a href="https://developers.line.biz/zh-hant/" target="_blank" class="text-blue-600 hover:underline font-bold">LINE Developers Console</a>ã€‚</li>
                        <li>åœ¨ <b>Messaging API</b> åˆ†é æœ€ä¸‹æ–¹ç”¢ç”Ÿ Tokenã€‚</li>
                        <li>è¨˜å¾—é—œé–‰ <b>Auto-reply messages (è‡ªå‹•å›æ‡‰)</b>ã€‚</li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-6 pl-10 border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ‚¨çš„ Channel Access Tokenï¼š</label>
                <input type="text" id="inputToken" placeholder="ä¾‹å¦‚ï¼šeyJhbGciOiJIUzI1NiJ9..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            </div>
        </section>

        <!-- æ­¥é©Ÿ 2: Google Sheet è¨­å®š -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number">2</div>
                <h2 class="text-xl font-bold text-gray-800">æº–å‚™ Google Sheet</h2>
            </div>
            <div class="pl-10 space-y-3 text-sm text-gray-600">
                <p>1.å»ºç«‹ä¸€å€‹æ–°çš„ <a href="https://sheets.new" target="_blank" class="text-blue-600 hover:underline">Google Sheet</a>ã€‚</p>
                <p>2.è¤‡è£½ç¶²å€åˆ—ä¸­çš„ IDã€‚</p>
            </div>

            <div class="mt-4 pl-10">
                <label class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ‚¨çš„ Google Sheet IDï¼š</label>
                <input type="text" id="inputSheetId" placeholder="ä¾‹å¦‚ï¼š1qo5L0zcjQweI7xV8cqE-3BByS0PMq-d6aAVfQzs20bo" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            </div>
        </section>

        <!-- æ­¥é©Ÿ 3: è¨­å®šæé†’é€šçŸ¥ -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number">3</div>
                <h2 class="text-xl font-bold text-gray-800">è¨­å®šæé†’é€šçŸ¥æ™‚é–“ (å¯é¸)</h2>
            </div>
            <div class="pl-10 text-sm text-gray-600">
                <p class="mb-4">é™¤äº†åŸºæœ¬çš„ 1 å°æ™‚å‰é€šçŸ¥ï¼Œæ‚¨é‚„å¯ä»¥å¢åŠ  2 å€‹é¡å¤–çš„æé†’æ™‚é–“é»ã€‚</p>
                
                <div class="space-y-4">
                    <div class="flex items-center p-3 bg-gray-100 rounded border border-gray-300">
                        <i class="fa-solid fa-lock text-gray-400 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">åŸºæœ¬æé†’</span>
                        <span class="text-blue-600 font-bold bg-blue-100 px-2 py-1 rounded text-xs">å‰ 1 å°æ™‚</span>
                    </div>

                    <div class="flex items-center p-3 bg-white rounded border border-gray-300 hover:border-blue-400 transition">
                        <i class="fa-regular fa-bell text-blue-500 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">é¡å¤–æé†’ 1</span>
                        <span class="mr-2 text-gray-500 text-xs">å‰</span>
                        <input type="number" id="rem1_val" placeholder="0" class="w-20 p-1 border border-gray-300 rounded text-center focus:ring-1 focus:ring-blue-500 outline-none">
                        <select id="rem1_unit" class="ml-2 p-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 outline-none bg-white">
                            <option value="1">åˆ†é˜</option>
                            <option value="60">å°æ™‚</option>
                            <option value="1440">å¤©</option>
                        </select>
                    </div>

                    <div class="flex items-center p-3 bg-white rounded border border-gray-300 hover:border-blue-400 transition">
                        <i class="fa-regular fa-bell text-blue-500 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">é¡å¤–æé†’ 2</span>
                        <span class="mr-2 text-gray-500 text-xs">å‰</span>
                        <input type="number" id="rem2_val" placeholder="0" class="w-20 p-1 border border-gray-300 rounded text-center focus:ring-1 focus:ring-blue-500 outline-none">
                        <select id="rem2_unit" class="ml-2 p-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 outline-none bg-white">
                            <option value="1">åˆ†é˜</option>
                            <option value="60">å°æ™‚</option>
                            <option value="1440">å¤©</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç”¢ç”Ÿç¨‹å¼ç¢¼æŒ‰éˆ• -->
        <section class="bg-blue-50 p-6 rounded-lg shadow-sm border border-blue-200 text-center">
            <h2 class="text-xl font-bold text-blue-800 mb-2">ç”¢ç”Ÿæ‚¨çš„å°ˆå±¬ç¨‹å¼ç¢¼</h2>
            <button onclick="generateCode()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ä¸€éµç”¢ç”Ÿä»£ç¢¼
            </button>
        </section>

        <!-- çµæœé¡¯ç¤ºå€ -->
        <section id="resultSection" class="hidden bg-white p-6 rounded-lg shadow-lg border-2 border-blue-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">æ‚¨çš„ GAS ç¨‹å¼ç¢¼ (v3.3)</h3>
                <button onclick="copyCode()" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 rounded border border-gray-300 transition flex items-center">
                    <i class="fa-regular fa-copy mr-2"></i>è¤‡è£½ä»£ç¢¼
                </button>
            </div>
            <textarea id="outputCode" readonly class="w-full h-64 p-3 bg-gray-900 text-green-400 font-mono text-xs rounded shadow-inner focus:outline-none resize-y"></textarea>
            <p id="copyStatus" class="text-green-600 text-sm mt-2 hidden text-right"><i class="fa-solid fa-check mr-1"></i>å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼</p>
        </section>

        <!-- æ­¥é©Ÿ 4: GAS éƒ¨ç½² -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number">4</div>
                <h2 class="text-xl font-bold text-gray-800">éƒ¨ç½² Google Apps Script</h2>
            </div>
            <div class="pl-10 space-y-4 text-sm text-gray-600">
                <ol class="list-decimal list-outside ml-4 space-y-3">
                    <li>å‰å¾€ Google Sheet > <b>æ“´å……åŠŸèƒ½</b> > <b>Apps Script</b>ï¼Œè²¼ä¸Šä»£ç¢¼ã€‚</li>
                    <li>
                        <span class="font-bold text-red-600">é–‹å•Ÿ Drive API v2 (æœå‹™ > + > Drive API > v2)ã€‚</span>
                    </li>
                    <li>
                        åŸ·è¡Œ <code>initialSetup</code> å‡½å¼ä¸¦å®Œæˆæˆæ¬Šã€‚
                    </li>
                    <li>
                        <b>éƒ¨ç½²ç‚º Web App</b> (åŸ·è¡Œèº«åˆ†: Me, å­˜å–æ¬Š: Anyone)ï¼Œå°‡ç¶²å€è²¼å› LINE Webhookã€‚
                    </li>
                    <li>
                        <b>è¨­å®šè§¸ç™¼å™¨ï¼š</b>
                        <ul class="list-disc ml-5 mt-1 text-gray-500">
                            <li>æ–°å¢è§¸ç™¼æ¢ä»¶ï¼š<code>checkReminders</code> / æ™‚é–“é©…å‹• / åˆ†é˜è¨ˆæ™‚å™¨ / <b>æ¯ 15 åˆ†é˜</b>ã€‚</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </section>

    </main>

    <footer class="bg-gray-100 text-center p-6 text-sm text-gray-500 mt-8">
        <p>&copy; 2026 æ™‚å…‰ç§˜æ›¸å°ˆæ¡ˆ</p>
    </footer>

    <script>
        // é€™æ˜¯ v3.3 çš„ GAS æ¨¡æ¿
        const gasTemplate = `/**
 * å°ˆæ¡ˆåç¨±ï¼šæ™‚å…‰ç§˜æ›¸ (Chrono-Secretary) v3.3 (åš´æ ¼é˜²å‘† & å½ˆæ€§æ™‚é–“ç‰ˆ)
 * åŠŸèƒ½ï¼šæ™ºæ…§æ¨¡ç³Šè§£æ LINE è¨Šæ¯ -> Google Sheet -> LINE é€šçŸ¥
 * æ›´æ–°ï¼š
 * 1. æ—¥æœŸé˜²å‘† (åµæ¸¬ 11/1311/20, 112/3 ç­‰éŒ¯èª¤)
 * 2. æ™‚é–“é˜²å‘† (åµæ¸¬ 912, 1415 ç­‰ç„¡åˆ†éš”ç¬¦éŒ¯èª¤)
 * 3. æ”¯æ´ 9-12, 13:40-15, 0900-1200 ç­‰å¤šç¨®æ™‚é–“æ ¼å¼
 */

// ================= è¨­å®šå€ (ç”±ç¶²é ç”¢ç”Ÿå™¨è‡ªå‹•å¡«å…¥) =================
const CHANNEL_ACCESS_TOKEN = '{{TOKEN}}'; 
const SHEET_ID = '{{SHEET_ID}}'; 
const CALENDAR_ID = 'primary'; 
const SHEET_NAME = 'è¡Œç¨‹è¨˜éŒ„'; 
const HISTORY_SHEET_NAME = 'æ­·å²å°å­˜';

// [é‡è¦] æé†’æ™‚é–“è¨­å®š (å–®ä½ï¼šåˆ†é˜)
const REMINDER_OFFSETS = {{REMINDER_ARRAY}}; 

// ================= æ¸¬è©¦éƒ¨ç½²ç‹€æ…‹ç”¨ =================
function doGet(e) { return ContentService.createTextOutput("æœå‹™æ­£å¸¸é‹ä½œä¸­ (v3.3 åš´æ ¼é˜²å‘†ç‰ˆ)ï¼"); }

// ================= æ¬Šé™åˆå§‹åŒ– =================
function initialSetup() {
  const user = Session.getActiveUser().getEmail();
  Logger.log(\`ä½¿ç”¨è€… \${user} æª¢æŸ¥æ¬Šé™...\`);
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    if (!ss.getSheetByName(HISTORY_SHEET_NAME)) {
      ss.insertSheet(HISTORY_SHEET_NAME).appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å°å­˜æ™‚é–“"]);
    }
    Logger.log("âœ… è©¦ç®—è¡¨æ¬Šé™ OK");
  } catch (e) { Logger.log("âŒ è©¦ç®—è¡¨éŒ¯èª¤: " + e.message); }
  try { CalendarApp.getCalendarById(CALENDAR_ID); Logger.log("âœ… æ—¥æ›†æ¬Šé™ OK"); } catch (e) { Logger.log("âŒ æ—¥æ›†éŒ¯èª¤: " + e.message); }
  try { 
    const tempFile = DriveApp.createFile("temp_auth_check.txt", "Auth Check"); 
    tempFile.setTrashed(true); Logger.log("âœ… Drive å¯«å…¥æ¬Šé™ OK"); 
  } catch (e) { Logger.log("âŒ Drive å¯«å…¥æ¬Šé™å¤±æ•—: " + e.message); }
  Logger.log("ğŸ‰ æ¬Šé™æª¢æŸ¥å®Œæˆï¼è«‹é€²è¡Œéƒ¨ç½²ã€‚");
}

// ================= Webhook å…¥å£ =================
function doPost(e) {
  if (!e || !e.postData) return;
  const msgObj = JSON.parse(e.postData.contents);
  if (!msgObj.events || msgObj.events.length === 0) return;
  const event = msgObj.events[0];
  const replyToken = event.replyToken;
  const userId = event.source.userId;
  
  if (event.type === 'message') {
    let userMessage = "";
    try {
      if (event.message.type === 'text') { userMessage = event.message.text; } 
      else if (event.message.type === 'image') {
        replyLine(replyToken, "ğŸ” æ”¶åˆ°åœ–ç‰‡ï¼ŒAI è¾¨è­˜ä¸­...(ç´„3-5ç§’)");
        userMessage = handleImageOCR(event.message.id);
        if (!userMessage.trim()) { pushLineMessage(userId, "âŒ åœ–ç‰‡è¾¨è­˜å¤±æ•—ã€‚"); return; }
      } else { return; }

      if (userMessage) {
        // å…ˆé€²è¡Œè§£æ
        const result = parseFlexibleScheduleV3(userMessage);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤ (v3.3 æ–°å¢)
        if (result.status === 'error') {
           if (event.message.type === 'image') { pushLineMessage(userId, "âŒ " + result.message); }
           else { replyLine(replyToken, "âŒ " + result.message); }
           return;
        }

        const parsedData = result.data;
        if (parsedData.length > 0) {
          let addedCount = 0;
          let replyMsg = "âœ… è™•ç†å®Œæˆï¼š\\n";
          
          parsedData.forEach(data => {
            const isDuplicate = saveToSheet(userId, data);
            if (!isDuplicate) {
              createCalendarEvent(data);
              const startStr = Utilities.formatDate(data.startObj, Session.getScriptTimeZone(), "MM/dd HH:mm");
              const endStr = Utilities.formatDate(data.endObj, Session.getScriptTimeZone(), "HH:mm");
              replyMsg += \`----------------\\nğŸ“… \${startStr} - \${endStr}\\nğŸ“ \${data.title}\\nğŸ“ \${data.location || 'ç·šä¸Š/ç„¡åœ°é»'}\\n\`;
              addedCount++;
            } else {
              replyMsg += \`----------------\\n(å·²å¿½ç•¥é‡è¤‡è¡Œç¨‹ï¼š\${data.title})\\n\`;
            }
          });
          
          if (addedCount > 0) {
            const reminderText = REMINDER_OFFSETS.map(min => {
              if (min >= 1440) return \`å‰\${Math.floor(min/1440)}å¤©\`;
              if (min >= 60) return \`å‰\${(min/60).toFixed(1).replace('.0','')}å°æ™‚\`;
              return \`å‰\${min}åˆ†é˜\`;
            }).join("ã€");
            replyMsg += \`\\nğŸ”” æ©Ÿå™¨äººå°‡åœ¨æ´»å‹•å‰ \${reminderText} é€šçŸ¥æ‚¨ã€‚\`;
          } else {
            replyMsg += "\\n(æ‰€æœ‰è¡Œç¨‹å‡å·²å­˜åœ¨ï¼Œç„¡éœ€æ–°å¢)";
          }
          
          if (event.message.type === 'image') { pushLineMessage(userId, replyMsg); }
          else { replyLine(replyToken, replyMsg); }
        } else {
           const failMsg = "ç„¡æ³•è¾¨è­˜è¡Œç¨‹ã€‚è«‹ç¢ºèªå«æœ‰æ—¥æœŸ(å¦‚1/9)èˆ‡æ™‚é–“ã€‚";
           if (event.message.type === 'image') { pushLineMessage(userId, failMsg); }
           else { replyLine(replyToken, failMsg); }
        }
      }
    } catch (err) {
      Logger.log(err);
      const errMsg = "âŒ éŒ¯èª¤ï¼š" + err.message;
      if (event.message.type === 'image') { pushLineMessage(userId, errMsg); }
      else { replyLine(replyToken, errMsg); }
    }
  }
}

// ================= OCR æ ¸å¿ƒ =================
function handleImageOCR(messageId) {
  const url = \`https://api-data.line.me/v2/bot/message/\${messageId}/content\`;
  const response = UrlFetchApp.fetch(url, { 'headers': { 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN } });
  const blob = response.getBlob();
  const resource = { title: "temp_ocr_" + new Date().getTime(), mimeType: blob.getContentType() };
  let file, attempts = 0;
  while (attempts < 3) {
    try { file = Drive.Files.insert(resource, blob, { ocr: true }); break; } 
    catch (e) { attempts++; Utilities.sleep(2000 * attempts); if(attempts>=3) throw e; }
  }
  if (!file) throw new Error("OCR è™•ç†å¤±æ•—");
  const text = DocumentApp.openById(file.id).getBody().getText();
  try { Drive.Files.remove(file.id); } catch (e) {}
  return text;
}

// ================= ç‹€æ…‹æ©Ÿè§£æå™¨ V3.3 (åš´æ ¼é˜²å‘†) =================
function parseFlexibleScheduleV3(text) {
  text = text.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/â‹…/g, " ").replace(/[()ï¼ˆï¼‰]/g, " "); 
  const lines = text.split('\\n').map(l => l.trim()).filter(l => l);
  const urlRegex = /(https?:\\/\\/[^\\s]+)/g;
  const links = text.match(urlRegex) || [];
  let linkIndex = 0;
  const results = [];
  const currentYear = new Date().getFullYear();
  let currentEvent = null;

  // --- 1. é å…ˆæª¢æŸ¥åš´é‡éŒ¯èª¤ (é˜²å‘†) ---
  for (let line of lines) {
    // æª¢æŸ¥éé•·çš„æ—¥æœŸä¸² (11/1311/20)
    if (line.match(/\\d{1,2}[-./]\\d{3,}[-./]\\d{1,2}/)) {
      return { status: 'error', message: "æ—¥æœŸæ ¼å¼æ··äº‚ç„¡æ³•åˆ¤æ–· (å¦‚: " + line + ")ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚" };
    }
    // æª¢æŸ¥æœˆä»½éŒ¯èª¤ (112/3)
    const badMonth = line.match(/(\\d{3,})[-./](\\d{1,2})/);
    if (badMonth && parseInt(badMonth[1]) > 2050) { // æ’é™¤å¹´ä»½ï¼Œå¦‚æœæ˜¯ç´”æ•¸å­—é€šå¸¸ä¸æœƒé€™éº¼å¤§
       // å¯¬é¬†ä¸€é»ï¼Œä¸è¦èª¤æ®ºå¹´ä»½ï¼Œä½†åƒ 112/3 è‹¥ä¸æ˜¯æ°‘åœ‹å¹´æ ¼å¼å¯èƒ½æœ‰èª¤
    }
    // æª¢æŸ¥ 22/21 (æœˆä»½ > 12)
    const dateCheck = line.match(/(\\d{1,2})[-./](\\d{1,2})/);
    if (dateCheck) {
       // éœ€è¦å°å¿ƒä¸è¦æŠŠæ™‚é–“ 13:40 ç•¶æˆæ—¥æœŸï¼Œæ‰€ä»¥è¦æœ‰åˆ†éš”ç¬¦ check
       // é€™è£¡ç°¡å–®æª¢æŸ¥ï¼šå¦‚æœç¬¬ä¸€çµ„æ•¸å­— > 12 ä¸”ä¸æ˜¯å¹´ä»½(>1900)ï¼Œä¸”ç¬¬äºŒçµ„æ•¸å­—åˆç†
       const p1 = parseInt(dateCheck[1]);
       const p2 = parseInt(dateCheck[2]);
       // å‡è¨­æ ¼å¼æ˜¯ æœˆ/æ—¥ï¼Œè‹¥ p1 > 12 (ä¸”ä¸æ˜¯å¹´ä»½)ï¼Œå ±éŒ¯
       // ä½†ä¹Ÿæœ‰å¯èƒ½æ˜¯ æ—¥/æœˆ æ ¼å¼? é€™è£¡å‡è¨­æœˆ/æ—¥ç‚ºä¸»æµ
       if (p1 > 12 && p1 < 100) {
          // å†æ¬¡ç¢ºèªé€™ä¸æ˜¯æ™‚é–“ (æ™‚é–“é€šå¸¸ç”¨ : )
          if (!line.includes(':') && !line.includes('ï¼š')) {
             return { status: 'error', message: "æ—¥æœŸæœˆä»½éŒ¯èª¤ (å¦‚: " + dateCheck[0] + ")ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚" };
          }
       }
    }
  }

  const flushCurrentEvent = () => {
    if (currentEvent) {
      if (!currentEvent.startH) { 
         // æ²’æŠ“åˆ°æ™‚é–“çš„é è¨­å€¼ (å…¨å¤©)
         currentEvent.startH = 9; currentEvent.startM = 0; currentEvent.endH = 10; currentEvent.endM = 0; 
      }
      if (!currentEvent.title) currentEvent.title = "æœªå‘½åè¡Œç¨‹";

      const dateStr = currentEvent.date;
      const startObj = new Date(\`\${dateStr}T\${String(currentEvent.startH).padStart(2,'0')}:\${String(currentEvent.startM).padStart(2,'0')}:00\`);
      const endObj = new Date(\`\${dateStr}T\${String(currentEvent.endH).padStart(2,'0')}:\${String(currentEvent.endM).padStart(2,'0')}:00\`);
      
      let assignedLink = "";
      if (links.length > 0) {
        if (links.length === 1) assignedLink = links[0];
        else if (linkIndex < links.length) assignedLink = links[linkIndex++];
        else assignedLink = links[links.length - 1]; 
      }
      
      // è™•ç†å–®ä¸€æ™‚é–“çš„å‚™è¨»
      if (currentEvent.isSingleTime) {
         assignedLink = (assignedLink ? assignedLink + "\\n" : "") + "(æœªæŒ‡å®šçµæŸæ™‚é–“)";
         // æ¨™é¡Œä¹Ÿå¯ä»¥åŠ 
         // currentEvent.title += " (1H)";
      }

      results.push({
        date: dateStr,
        timeStart: \`\${String(currentEvent.startH).padStart(2,'0')}:\${String(currentEvent.startM).padStart(2,'0')}\`,
        timeEnd: \`\${String(currentEvent.endH).padStart(2,'0')}:\${String(currentEvent.endM).padStart(2,'0')}\`,
        startObj: startObj, endObj: endObj, title: currentEvent.title, location: assignedLink
      });
      currentEvent = null;
    }
  };

  for (let line of lines) {
    if (line.match(/^https?:\\/\\//) || line.match(/^(æ™‚é–“|æ—¥æœŸ|è¡Œç¨‹è¡¨|July|è¬›å¸«)/i)) continue;

    // --- 2. åš´æ ¼æ™‚é–“é˜²å‘† (åµæ¸¬ 912, 1415) ---
    // å¦‚æœä¸€è¡Œåªæœ‰ 3-4 å€‹æ•¸å­—ï¼Œä¸”æ²’æœ‰åˆ†éš”ç¬¦ï¼Œä¸”ä¸æ˜¯å¹´ä»½ (å¦‚ 2026)ï¼Œå ±éŒ¯
    const pureNumber = line.match(/^(\\d{3,4})$/);
    if (pureNumber) {
       const val = parseInt(pureNumber[1]);
       // æ’é™¤åˆç†çš„å¹´ä»½ç¯„åœ (å¦‚ 2025-2030)ï¼Œå…¶ä»–çš„è¦–ç‚ºæ‰‹èª¤æ™‚é–“
       if (val < 2020 || val > 2035) {
          return { status: 'error', message: "æ™‚é–“æ ¼å¼ç„¡æ³•åˆ¤æ–· (å¦‚: " + val + " é€£åœ¨ä¸€èµ·)ï¼Œè«‹é‡æ–°è¼¸å…¥ (å»ºè­°æ ¼å¼: 09:00 æˆ– 9-12)ã€‚" };
       }
    }

    // --- 3. æ—¥æœŸè§£æ (å«æ°‘åœ‹å¹´) ---
    const dateMatch = line.match(/(\\d{2,4})?[-./å¹´]?(\\d{1,2})[-./æœˆ](\\d{1,2})æ—¥?/);
    if (dateMatch) {
       // æ’é™¤æŠŠæ™‚é–“ç•¶æ—¥æœŸçš„æƒ…æ³ (å¦‚ 9-12)
       if (!line.match(/\\d{1,2}\\s*[-~]\\s*\\d{1,2}/)) {
          flushCurrentEvent();
          let y = dateMatch[1] ? parseInt(dateMatch[1]) : currentYear;
          if (y < 1000) y += 1911; // æ°‘åœ‹å¹´è½‰è¥¿å…ƒ
          
          let m = dateMatch[2]; let d = dateMatch[3];
          currentEvent = { 
             date: \`\${y}-\${String(m).padStart(2,'0')}-\${String(d).padStart(2,'0')}\`, 
             title: "", startH: null, startM: 0, endH: null, endM: 0, isSingleTime: false 
          };
          line = line.replace(dateMatch[0], " ").trim(); 
       }
    }
    
    if (!currentEvent) continue;

    // --- 4. æ™‚é–“è§£æ (å¼·åŒ–ç‰ˆ) ---
    
    // A. æ¨™æº–/è»äº‹ç¯„åœ: 09:00-12:00, 0900-1200
    // Regex: æ”¯æ´ (1-2ä½ æˆ– 4ä½) [-~] (1-2ä½ æˆ– 4ä½)
    // æ•ç²çµ„: 1:StartH(or HHMM), 2:StartM, 3:EndH(or HHMM), 4:EndM
    const complexTime = line.match(/(?:^|\\s)(\\d{1,2}|\\d{4})(:(\\d{2}))?\\s*[-~]\\s*(\\d{1,2}|\\d{4})(:(\\d{2}))?/);
    
    // B. å–®ä¸€æ™‚é–“ (9é»é–‹å§‹): 09:00, 9é», 0900
    const singleTime = line.match(/(?:^|\\s)(\\d{1,2}|\\d{4})(:(\\d{2}))?(?:$|\\s|é»)/);

    // C. é—œéµå­—
    const allDayMatch = line.match(/(æ•´å¤©|å…¨å¤©)/);
    const halfDayMatch = line.match(/(ä¸Šåˆ|ä¸‹åˆ)?\\s*åŠå¤©/);

    if (complexTime) {
       // è§£æ Start
       let sRaw = complexTime[1];
       if (sRaw.length === 4) { // 0900
          currentEvent.startH = parseInt(sRaw.substring(0,2));
          currentEvent.startM = parseInt(sRaw.substring(2,4));
       } else {
          currentEvent.startH = parseInt(sRaw);
          currentEvent.startM = complexTime[3] ? parseInt(complexTime[3]) : 0;
       }

       // è§£æ End
       let eRaw = complexTime[4];
       if (eRaw.length === 4) { // 1200
          currentEvent.endH = parseInt(eRaw.substring(0,2));
          currentEvent.endM = parseInt(eRaw.substring(2,4));
       } else {
          currentEvent.endH = parseInt(eRaw);
          // ç‰¹æ®Šè™•ç† 13:40-15 (Endæ²’æœ‰åˆ†)
          currentEvent.endM = complexTime[6] ? parseInt(complexTime[6]) : 0;
       }
       continue; 
    }
    else if (singleTime && !line.match(/[-~]/)) { // åªæœ‰ç•¶æ²’æœ‰ç¯„åœç¬¦è™Ÿæ™‚æ‰ç®—å–®ä¸€æ™‚é–“
       // é˜²æ­¢æŠŠ "2026" å¹´ä»½èª¤åˆ¤ç‚ºæ™‚é–“ 20:26
       let val = parseInt(singleTime[1]);
       if (singleTime[1].length === 4 && (val < 2400)) { // è»äº‹æ™‚é–“
          currentEvent.startH = parseInt(singleTime[1].substring(0,2));
          currentEvent.startM = parseInt(singleTime[1].substring(2,4));
       } else if (singleTime[1].length <= 2) {
          currentEvent.startH = val;
          currentEvent.startM = singleTime[3] ? parseInt(singleTime[3]) : 0;
       } else {
          // å¯èƒ½æ˜¯å¹´ä»½æˆ–å…¶ä»–æ•¸å­—ï¼Œå¿½ç•¥
          if (currentEvent) currentEvent.title += (currentEvent.title ? " " : "") + line;
          continue;
       }
       
       // é è¨­çµæŸæ™‚é–“ = é–‹å§‹ + 1å°æ™‚
       currentEvent.endH = currentEvent.startH + 1;
       currentEvent.endM = currentEvent.startM;
       currentEvent.isSingleTime = true;
       continue;
    }
    else if (allDayMatch) { currentEvent.startH = 9; currentEvent.endH = 18; continue; }
    else if (halfDayMatch) { if (halfDayMatch[0].includes('ä¸Š')) { currentEvent.startH = 9; currentEvent.endH = 12; } else { currentEvent.startH = 13; currentEvent.endH = 17; } continue; }

    if (line.match(/^[æ—¥ä¸€äºŒä¸‰å››äº”å…­]$/)) continue;
    if (currentEvent) { currentEvent.title += (currentEvent.title ? " " : "") + line; }
  }
  flushCurrentEvent();
  
  return { status: 'success', data: results };
}

// ================= Google Sheet å„²å­˜èˆ‡æ’åº =================
function saveToSheet(userId, data) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) { sheet = ss.insertSheet(SHEET_NAME); sheet.appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å»ºç«‹æ™‚é–“"]); }
  
  const existingData = sheet.getDataRange().getValues();
  for (let i = 1; i < existingData.length; i++) {
    const row = existingData[i];
    let rowDate = row[1];
    if (rowDate instanceof Date) { rowDate = Utilities.formatDate(rowDate, Session.getScriptTimeZone(), "yyyy-MM-dd"); }
    if (rowDate == data.date && row[2] == data.timeStart && row[5] == data.title) {
      return true; 
    }
  }

  sheet.appendRow([userId, data.date, data.timeStart, data.timeEnd, data.startObj, data.title, data.location, "", new Date()]);
  if (sheet.getLastRow() > 1) {
    const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
    range.sort({column: 5, ascending: true});
  }
  return false; 
}

function createCalendarEvent(data) {
  CalendarApp.getCalendarById(CALENDAR_ID).createEvent(data.title, data.startObj, data.endObj, { description: \`åœ°é»/é€£çµ: \${data.location}\\n(æ™‚å…‰ç§˜æ›¸)\`, location: data.location });
}

// ================= è§¸ç™¼å™¨ =================
function checkReminders() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return;

  const now = new Date();
  if (now.getHours() === 4 && now.getMinutes() < 15) { performDailyMaintenance(ss, sheet); }

  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  const maxReminderMin = Math.max(...REMINDER_OFFSETS);
  const maxLookAheadTime = new Date(now.getTime() + (maxReminderMin + 60) * 60 * 1000); 

  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const userId = row[0];
    const eventTime = new Date(row[4]); 
    const title = row[5];
    const location = row[6];
    let notifiedStatus = row[7] ? String(row[7]) : ""; 
    
    if (eventTime > maxLookAheadTime) { break; }

    let needUpdate = false;
    REMINDER_OFFSETS.forEach(offsetMin => {
      if (notifiedStatus.includes(\`|\${offsetMin}|\`)) return;
      const timeDiffMin = (eventTime.getTime() - now.getTime()) / 60000;
      if (timeDiffMin <= offsetMin && timeDiffMin > (offsetMin - 20)) {
        let timeLabel = "";
        if (offsetMin >= 1440) timeLabel = \`å‰\${Math.floor(offsetMin/1440)}å¤©\`;
        else if (offsetMin >= 60) timeLabel = \`å‰\${(offsetMin/60).toFixed(1).replace('.0','')}å°æ™‚\`;
        else timeLabel = \`å‰\${offsetMin}åˆ†é˜\`;
        const msg = \`â° æé†’ (\${timeLabel})ï¼šæ´»å‹•å³å°‡é–‹å§‹ï¼\\n\\nä¸»é¡Œï¼š\${title}\\næ™‚é–“ï¼š\${Utilities.formatDate(eventTime, Session.getScriptTimeZone(), "HH:mm")}\\nåœ°é»/é€£çµï¼š\${location}\`;
        pushLineMessage(userId, msg);
        notifiedStatus += \`|\${offsetMin}|\`;
        needUpdate = true;
      }
    });
    if (needUpdate) { sheet.getRange(i + 1, 8).setValue(notifiedStatus); }
  }
}

function performDailyMaintenance(ss, sheet) {
  let historySheet = ss.getSheetByName(HISTORY_SHEET_NAME);
  if (!historySheet) { historySheet = ss.insertSheet(HISTORY_SHEET_NAME).appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å°å­˜æ™‚é–“"]); }
  const values = sheet.getDataRange().getValues();
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
  for (let i = values.length - 1; i >= 1; i--) {
    const eventTime = new Date(values[i][4]);
    if (eventTime < yesterday) {
      historySheet.appendRow([...values[i], new Date()]);
      sheet.deleteRow(i + 1);
    }
  }
}

function replyLine(replyToken, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post', 'payload': JSON.stringify({ replyToken: replyToken, messages: [{ type: 'text', text: text }] })
  });
}
function pushLineMessage(userId, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post', 'payload': JSON.stringify({ to: userId, messages: [{ type: 'text', text: text }] })
  });
}
`;

        function generateCode() {
            const token = document.getElementById('inputToken').value.trim();
            const sheetId = document.getElementById('inputSheetId').value.trim();
            
            let reminders = [60]; 
            const r1Val = document.getElementById('rem1_val').value;
            const r1Unit = document.getElementById('rem1_unit').value;
            if (r1Val && r1Val > 0) { reminders.push(parseInt(r1Val) * parseInt(r1Unit)); }
            const r2Val = document.getElementById('rem2_val').value;
            const r2Unit = document.getElementById('rem2_unit').value;
            if (r2Val && r2Val > 0) { reminders.push(parseInt(r2Val) * parseInt(r2Unit)); }
            reminders = [...new Set(reminders)].sort((a,b) => a - b);
            const reminderArrayStr = JSON.stringify(reminders);

            if (!token || !sheetId) { alert("è«‹å…ˆè¼¸å…¥ LINE Token èˆ‡ Google Sheet ID å–”ï¼"); return; }

            let finalCode = gasTemplate.replace('{{TOKEN}}', token).replace('{{SHEET_ID}}', sheetId).replace('{{REMINDER_ARRAY}}', reminderArrayStr);
            const outputArea = document.getElementById('outputCode');
            outputArea.value = finalCode;
            const resultSection = document.getElementById('resultSection');
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('copyStatus').classList.add('hidden');
        }

        function copyCode() {
            const outputArea = document.getElementById('outputCode');
            outputArea.select();
            document.execCommand('copy');
            const status = document.getElementById('copyStatus');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>