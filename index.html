<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰ç§˜æ›¸ - è‡ªå‹•åŒ–è¡Œç¨‹åŠ©ç†ç”¢ç”Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-indigo-600 text-white p-6 shadow-md">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold"><i class="fa-solid fa-robot mr-2"></i>æ™‚å…‰ç§˜æ›¸ (Chrono-Secretary)</h1>
                <p class="text-indigo-100 text-sm mt-1">v10.0 çµ‚æ¥µå®Œæ•´ç‰ˆ</p>
            </div>
            <div class="text-3xl opacity-20"><i class="fa-regular fa-calendar-check"></i></div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6 space-y-8">

        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘‘ v10.0 çµ‚æ¥µå®Œæ•´ç‰ˆ</h2>
            <p class="text-gray-600 leading-relaxed mb-4">
                é€™æ˜¯é›†å¤§æˆçš„ç‰ˆæœ¬ï¼Œæ•´åˆäº†éå»æ‰€æœ‰ä¿®æ­£éœ€æ±‚ï¼Œç¢ºä¿åˆ¤æ–·é‚è¼¯æœ€ç‚ºåš´è¬¹å…¨é¢ã€‚
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                <ul class="list-disc list-inside space-y-2">
                    <li>âœ… <b>å…¨æ ¼å¼æ”¯æ´ï¼š</b>è¡¨æ ¼ã€åˆ—è¡¨ã€é•·æ–‡ã€èŠå¤©è¨˜éŒ„è¤‡è£½ã€‚</li>
                    <li>âœ… <b>ç²¾æº–æ™‚é–“ï¼š</b>æ”¯æ´æ™šé–“(PM)ã€è·¨è¡Œæ™‚é–“ã€ç·Šæ¹Šæ™‚é–“æ ¼å¼ã€‚</li>
                    <li>âœ… <b>æ°‘åœ‹å¹´ä¿®å¾©ï¼š</b>å®Œç¾æ”¯æ´ 115å¹´ ç­‰æ°‘åœ‹ç´€å¹´ï¼Œé˜²æ­¢æ–·è©éŒ¯èª¤ã€‚</li>
                    <li>âœ… <b>æ™ºæ…§å…§å®¹ï¼š</b>è‡ªå‹•ç¹¼æ‰¿æ¨™é¡Œã€è‡ªå‹•æŠ“å–å¤šè¡Œåœ°é»ã€‚</li>
                </ul>
                <ul class="list-disc list-inside space-y-2">
                    <li>âœ… <b>æŒ‡ä»¤ç³»çµ±ï¼š</b>æŸ¥è©¢ (1/20)ã€åˆªé™¤ (åˆªé™¤ 1/20)ã€HELPã€‚</li>
                    <li>âœ… <b>é‡è¤‡é˜²å‘†ï¼š</b>å®Œå…¨ç›¸åŒçš„è¡Œç¨‹è‡ªå‹•ç•¥éã€‚</li>
                    <li>âœ… <b>è¨Šæ¯é˜²çˆ†ï¼š</b>è‡ªå‹•æˆªæ–·éé•·è¨Šæ¯ï¼Œé¿å… Error 400ã€‚</li>
                    <li>âœ… <b>æ¨™é¡Œæ·¨åŒ–ï¼š</b>è‡ªå‹•ç§»é™¤ (å…­)ã€æ—¥ ç­‰æ®˜å­—ã€‚</li>
                </ul>
            </div>
        </section>

        <!-- æ­¥é©Ÿ 1: LINE è¨­å®š -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">1</div>
                <h2 class="text-xl font-bold text-gray-800">å»ºç«‹ LINE å®˜æ–¹å¸³è™Ÿèˆ‡å–å¾— Token</h2>
            </div>
            <div class="pl-10 space-y-6 text-sm text-gray-600">
                <div>
                    <h3 class="font-bold text-indigo-700 mb-2"><i class="fa-solid fa-key mr-1"></i> å–å¾— Channel Access Token</h3>
                    <ul class="list-decimal ml-5 space-y-2">
                        <li>å‰å¾€ <a href="https://developers.line.biz/zh-hant/" target="_blank" class="text-indigo-600 hover:underline font-bold">LINE Developers Console</a>ã€‚</li>
                        <li>åœ¨ <b>Messaging API</b> åˆ†é æœ€ä¸‹æ–¹ç”¢ç”Ÿ Tokenã€‚</li>
                        <li>è¨˜å¾—é—œé–‰ <b>Auto-reply messages (è‡ªå‹•å›æ‡‰)</b>ã€‚</li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 pl-10 border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ‚¨çš„ Channel Access Tokenï¼š</label>
                <input type="text" id="inputToken" placeholder="ä¾‹å¦‚ï¼šeyJhbGciOiJIUzI1NiJ9..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
            </div>
        </section>

        <!-- æ­¥é©Ÿ 2: Google Sheet è¨­å®š -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">2</div>
                <h2 class="text-xl font-bold text-gray-800">æº–å‚™ Google Sheet</h2>
            </div>
            <div class="pl-10 space-y-3 text-sm text-gray-600">
                <p>1.å»ºç«‹ä¸€å€‹æ–°çš„ <a href="https://sheets.new" target="_blank" class="text-indigo-600 hover:underline">Google Sheet</a>ã€‚</p>
                <p>2.è¤‡è£½ç¶²å€åˆ—ä¸­çš„ IDã€‚</p>
            </div>
            <div class="mt-4 pl-10">
                <label class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ‚¨çš„ Google Sheet IDï¼š</label>
                <input type="text" id="inputSheetId" placeholder="ä¾‹å¦‚ï¼š1qo5L0zcjQweI7xV8cqE-3BByS0PMq-d6aAVfQzs20bo" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
            </div>
        </section>

        <!-- æ­¥é©Ÿ 3: è¨­å®šæé†’é€šçŸ¥ -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">3</div>
                <h2 class="text-xl font-bold text-gray-800">è¨­å®šæé†’é€šçŸ¥æ™‚é–“ (å¯é¸)</h2>
            </div>
            <div class="pl-10 text-sm text-gray-600">
                <p class="mb-4">é™¤äº†åŸºæœ¬çš„ 1 å°æ™‚å‰é€šçŸ¥ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å¢åŠ é¡å¤–çš„æé†’æ™‚é–“ã€‚</p>
                
                <div class="space-y-4">
                    <div class="flex items-center p-3 bg-gray-100 rounded border border-gray-300">
                        <i class="fa-solid fa-lock text-gray-400 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">åŸºæœ¬æé†’</span>
                        <span class="text-indigo-600 font-bold bg-indigo-100 px-2 py-1 rounded text-xs">å‰ 1 å°æ™‚</span>
                    </div>

                    <div class="flex items-center p-3 bg-white rounded border border-gray-300 hover:border-indigo-400 transition">
                        <i class="fa-regular fa-bell text-indigo-500 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">é¡å¤–æé†’ 1</span>
                        <span class="mr-2 text-gray-500 text-xs">å‰</span>
                        <input type="number" id="rem1_val" placeholder="0" class="w-20 p-1 border border-gray-300 rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none">
                        <select id="rem1_unit" class="ml-2 p-1 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 outline-none bg-white">
                            <option value="1">åˆ†é˜</option>
                            <option value="60">å°æ™‚</option>
                            <option value="1440">å¤©</option>
                        </select>
                    </div>

                    <div class="flex items-center p-3 bg-white rounded border border-gray-300 hover:border-indigo-400 transition">
                        <i class="fa-regular fa-bell text-indigo-500 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">é¡å¤–æé†’ 2</span>
                        <span class="mr-2 text-gray-500 text-xs">å‰</span>
                        <input type="number" id="rem2_val" placeholder="0" class="w-20 p-1 border border-gray-300 rounded text-center focus:ring-1 focus:ring-indigo-500 outline-none">
                        <select id="rem2_unit" class="ml-2 p-1 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 outline-none bg-white">
                            <option value="1">åˆ†é˜</option>
                            <option value="60">å°æ™‚</option>
                            <option value="1440">å¤©</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç”¢ç”Ÿç¨‹å¼ç¢¼æŒ‰éˆ• -->
        <section class="bg-indigo-50 p-6 rounded-lg shadow-sm border border-indigo-200 text-center">
            <h2 class="text-xl font-bold text-indigo-800 mb-2">ç”¢ç”Ÿæ‚¨çš„å°ˆå±¬ç¨‹å¼ç¢¼</h2>
            <button onclick="generateCode()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ä¸€éµç”¢ç”Ÿä»£ç¢¼
            </button>
        </section>

        <!-- çµæœé¡¯ç¤ºå€ -->
        <section id="resultSection" class="hidden bg-white p-6 rounded-lg shadow-lg border-2 border-indigo-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">æ‚¨çš„ GAS ç¨‹å¼ç¢¼ (v10.0)</h3>
                <button onclick="copyCode()" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 rounded border border-gray-300 transition flex items-center">
                    <i class="fa-regular fa-copy mr-2"></i>è¤‡è£½ä»£ç¢¼
                </button>
            </div>
            <textarea id="outputCode" readonly class="w-full h-64 p-3 bg-gray-900 text-green-400 font-mono text-xs rounded shadow-inner focus:outline-none resize-y"></textarea>
            <p id="copyStatus" class="text-green-600 text-sm mt-2 hidden text-right"><i class="fa-solid fa-check mr-1"></i>å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼</p>
        </section>

        <!-- æ­¥é©Ÿ 4: GAS éƒ¨ç½² -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #4f46e5; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">4</div>
                <h2 class="text-xl font-bold text-gray-800">éƒ¨ç½² Google Apps Script</h2>
            </div>
            <div class="pl-10 space-y-4 text-sm text-gray-600">
                <ol class="list-decimal list-outside ml-4 space-y-3">
                    <li>å‰å¾€ Google Sheet > <b>æ“´å……åŠŸèƒ½</b> > <b>Apps Script</b>ï¼Œè²¼ä¸Šä»£ç¢¼ã€‚</li>
                    <li>
                        <span class="font-bold text-red-600">é–‹å•Ÿ Drive API v2 (æœå‹™ > + > Drive API > v2)ã€‚</span>
                    </li>
                    <li>
                        åŸ·è¡Œ <code>initialSetup</code> å‡½å¼ä¸¦å®Œæˆæˆæ¬Šã€‚
                    </li>
                    <li class="bg-yellow-50 p-2 rounded border-l-4 border-yellow-400">
                        <span class="font-bold text-yellow-800">ã€éå¸¸é‡è¦ã€‘å»ºç«‹æ–°ç‰ˆæœ¬ï¼š</span>
                        <br>æ¯æ¬¡æ›´æ–°ç¨‹å¼ç¢¼å¾Œï¼Œä¸€å®šè¦é»æ“Š <b>éƒ¨ç½²</b> > <b>ç®¡ç†éƒ¨ç½²</b> > é»æ“Šç­†åœ–ç¤º > ç‰ˆæœ¬é¸æ“‡ <b>ã€Œæ–°ç‰ˆæœ¬ã€</b> > <b>éƒ¨ç½²</b>ã€‚
                    </li>
                    <li>
                        <b>è¨­å®šè§¸ç™¼å™¨ï¼š</b>
                        <ul class="list-disc ml-5 mt-1 text-gray-500">
                            <li>æ–°å¢è§¸ç™¼æ¢ä»¶ï¼š<code>checkReminders</code> / æ™‚é–“é©…å‹• / åˆ†é˜è¨ˆæ™‚å™¨ / <b>æ¯ 15 åˆ†é˜</b>ã€‚</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </section>

    </main>

    <footer class="bg-gray-100 text-center p-6 text-sm text-gray-500 mt-8">
        <p>&copy; 2026 æ™‚å…‰ç§˜æ›¸å°ˆæ¡ˆ</p>
    </footer>

    <script>
        const gasTemplate = `/**
 * å°ˆæ¡ˆåç¨±ï¼šæ™‚å…‰ç§˜æ›¸ (Chrono-Secretary) v10.0 (çµ‚æ¥µå®Œæ•´ç‰ˆ)
 * åŠŸèƒ½ï¼šæ™ºæ…§è§£æ LINE è¨Šæ¯ -> Google Sheet -> LINE é€šçŸ¥
 * ç‰ˆæœ¬æ­·å²ï¼šæ•´åˆäº† v1.0 è‡³ v9.2 æ‰€æœ‰ä¿®æ­£
 * 1. æ ¼å¼æ”¯æ´ï¼šOCRåœ–ç‰‡ã€è¡¨æ ¼ã€æ–‡å­—ã€åˆ—è¡¨
 * 2. æ™‚é–“åˆ¤è®€ï¼šæ™šé–“ä¿®æ­£ã€è·¨è¡Œæœç´¢ã€æ ¼å¼è‡ªå‹•ä¿®å¾©
 * 3. æ—¥æœŸåˆ¤è®€ï¼šæ°‘åœ‹å¹´(115å¹´)ä¿®å¾©ã€æœˆä»½æƒ…å¢ƒæ„ŸçŸ¥
 * 4. å…§å®¹è™•ç†ï¼šå…¨åŸŸæ¨™é¡Œç¹¼æ‰¿ã€å¤šè¡Œåœ°é»åˆä½µã€èŠå¤©è¨˜éŒ„æ·¨åŒ–
 * 5. ç³»çµ±åŠŸèƒ½ï¼šæŸ¥è©¢ã€åˆªé™¤ã€HELPã€é‡è¤‡é˜²å‘†ã€è¨Šæ¯é˜²çˆ†
 */

// ================= è¨­å®šå€ (ç”±ç¶²é ç”¢ç”Ÿå™¨è‡ªå‹•å¡«å…¥) =================
const CHANNEL_ACCESS_TOKEN = '{{TOKEN}}'; 
const SHEET_ID = '{{SHEET_ID}}'; 
const CALENDAR_ID = 'primary'; 
const SHEET_NAME = 'è¡Œç¨‹è¨˜éŒ„'; 
const HISTORY_SHEET_NAME = 'æ­·å²å°å­˜';

// [é‡è¦] æé†’æ™‚é–“è¨­å®š
const REMINDER_OFFSETS = {{REMINDER_ARRAY}}; 

function doGet(e) { return ContentService.createTextOutput("æœå‹™æ­£å¸¸é‹ä½œä¸­ (v10.0 çµ‚æ¥µç‰ˆ)ï¼"); }

function initialSetup() {
  const user = Session.getActiveUser().getEmail();
  Logger.log(\`ä½¿ç”¨è€… \${user} æª¢æŸ¥æ¬Šé™...\`);
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    if (!ss.getSheetByName(HISTORY_SHEET_NAME)) {
      ss.insertSheet(HISTORY_SHEET_NAME).appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å°å­˜æ™‚é–“"]);
    }
    Logger.log("âœ… è©¦ç®—è¡¨æ¬Šé™ OK");
  } catch (e) { Logger.log("âŒ è©¦ç®—è¡¨éŒ¯èª¤: " + e.message); }
  try { CalendarApp.getCalendarById(CALENDAR_ID); Logger.log("âœ… æ—¥æ›†æ¬Šé™ OK"); } catch (e) { Logger.log("âŒ æ—¥æ›†éŒ¯èª¤: " + e.message); }
  try { 
    const tempFile = DriveApp.createFile("temp_auth_check.txt", "Auth Check"); 
    tempFile.setTrashed(true); Logger.log("âœ… Drive å¯«å…¥æ¬Šé™ OK"); 
  } catch (e) { Logger.log("âŒ Drive å¯«å…¥æ¬Šé™å¤±æ•—: " + e.message); }
  Logger.log("ğŸ‰ æ¬Šé™æª¢æŸ¥å®Œæˆï¼è«‹é€²è¡Œéƒ¨ç½²ã€‚");
}

function doPost(e) {
  if (!e || !e.postData) return;
  const msgObj = JSON.parse(e.postData.contents);
  if (!msgObj.events || msgObj.events.length === 0) return;
  const event = msgObj.events[0];
  const replyToken = event.replyToken;
  const userId = event.source.userId;
  
  if (event.type === 'message') {
    let userMessage = "";
    
    if (event.message.type === 'image') {
      try {
        replyLine(replyToken, "ğŸ” æ”¶åˆ°åœ–ç‰‡ï¼Œæ­£åœ¨é€²è¡Œ AI è¾¨è­˜èˆ‡æ•´ç†... (è«‹ç¨å€™)");
      } catch (e) { Logger.log("Reply failed: " + e.message); }
      
      try {
        userMessage = handleImageOCR(event.message.id);
        if (!userMessage.trim()) { 
          pushLineMessage(userId, "âŒ åœ–ç‰‡è¾¨è­˜å¤±æ•—ï¼Œç„¡æ³•è®€å–æ–‡å­—ã€‚"); 
          return; 
        }
      } catch (err) {
        pushLineMessage(userId, "âŒ è™•ç†éŒ¯èª¤ï¼š" + err.message);
        return;
      }
    } else if (event.message.type === 'text') {
      userMessage = event.message.text;
      
      // æŒ‡ä»¤æª¢æŸ¥ (HELP/æŸ¥è©¢/åˆªé™¤)
      if (handleUserCommand(userMessage, replyToken, userId)) {
        return; 
      }

    } else { return; }

    if (userMessage) {
      try {
        // 1. èŠå¤©è¨˜éŒ„æ·¨åŒ–
        const cleanMessage = cleanChatLog(userMessage);
        // 2. çµ‚æ¥µè§£æ
        const result = parseScheduleUltimate(cleanMessage); 
        
        if (result.status === 'error') {
           if (event.message.type === 'image') { pushLineMessage(userId, "âŒ " + result.message); }
           else { replyLine(replyToken, "âŒ " + result.message); }
           return;
        }

        const parsedData = result.data;
        if (parsedData.length > 0) {
          const batchResult = processEventsBatch(userId, parsedData);
          
          let replyMsg = "";
          
          if (batchResult.added.length > 0) {
             replyMsg += "âœ… è¡Œç¨‹å·²å®‰æ’ä¸¦æ’åºï¼š\\n";
             batchResult.added.forEach(data => {
                const startStr = Utilities.formatDate(data.startObj, Session.getScriptTimeZone(), "MM/dd HH:mm");
                const endStr = Utilities.formatDate(data.endObj, Session.getScriptTimeZone(), "HH:mm");
                replyMsg += \`----------------\\nğŸ“… \${startStr} - \${endStr}\\nğŸ“ \${data.title}\\nğŸ“ \${data.location || 'ç·šä¸Š/ç„¡åœ°é»'}\\n\`;
             });
          }

          if (batchResult.ignored.length > 0) {
             replyMsg += \`\\nâš ï¸ ç™¼ç¾ \${batchResult.ignored.length} ç­†é‡è¤‡è¡Œç¨‹ (å·²è‡ªå‹•ç•¥é)ï¼š\\n\`;
             batchResult.ignored.forEach(title => {
                replyMsg += \`â€¢ \${title}\\n\`;
             });
          }
          
          if (batchResult.added.length > 0) {
            const reminderText = REMINDER_OFFSETS.map(min => {
              if (min >= 1440) return \`å‰ \${Math.floor(min/1440)} å¤©\`;
              if (min >= 60) return \`å‰ \${(min/60).toFixed(1).replace('.0','')} å°æ™‚\`;
              return \`å‰ \${min} åˆ†é˜\`;
            }).join("ã€");
            replyMsg += \`\\nğŸ”” æ©Ÿå™¨äººå°‡åœ¨æ´»å‹• \${reminderText} é€šçŸ¥æ‚¨ã€‚\`;
          } else if (batchResult.ignored.length > 0 && batchResult.added.length === 0) {
            replyMsg += "\\n(æ‰€æœ‰è¡Œç¨‹å‡å·²å­˜åœ¨ï¼Œç„¡éœ€æ–°å¢)";
          }
          
          if (event.message.type === 'image') { 
            pushLineMessage(userId, replyMsg); 
          } else { 
            replyLine(replyToken, replyMsg); 
          }
        } else {
           const msg = "ç„¡æ³•è¾¨è­˜è¡Œç¨‹ã€‚\\nè«‹è¼¸å…¥ã€ŒHELPã€æŸ¥çœ‹æ•™å­¸ï¼Œæˆ–ç¢ºèªè¼¸å…¥å«æœ‰æ—¥æœŸ(å¦‚1/20)æˆ–æœˆä»½æ¨™é¡Œã€‚";
           if (event.message.type === 'image') pushLineMessage(userId, msg);
           else replyLine(replyToken, msg);
        }
      } catch (err) {
        Logger.log(err);
        const errMsg = "âŒ ç³»çµ±éŒ¯èª¤ï¼š" + err.message;
        if (event.message.type === 'image') pushLineMessage(userId, errMsg);
        else replyLine(replyToken, errMsg);
      }
    }
  }
}

// ---------------- æ ¸å¿ƒåŠŸèƒ½å€ ----------------

// èŠå¤©è¨˜éŒ„æ·¨åŒ–ï¼šç§»é™¤è¡Œé¦–çš„ 11:35 æˆ– ä¸Šåˆ 11:35 æ ¼å¼
function cleanChatLog(text) {
  const lines = text.split('\\n');
  const cleanedLines = lines.map(line => {
    return line.replace(/^(ä¸Šåˆ|ä¸‹åˆ)?\s*(\d{1,2}:\d{2})\s+(?=\S)/, "");
  });
  return cleanedLines.join('\\n');
}

// ä½¿ç”¨è€…æŒ‡ä»¤è™•ç†
function handleUserCommand(text, replyToken, userId) {
  const lowerText = text.toLowerCase().trim();

  // HELP
  if (lowerText === 'help' || lowerText === 'åŠŸèƒ½' || lowerText === 'æŒ‡ä»¤' || lowerText === 'èªªæ˜' || lowerText === 'æ€éº¼ç”¨' || lowerText === 'æ•™å­¸') {
    const helpMsg = "ğŸ¤– æ™‚å…‰ç§˜æ›¸ä½¿ç”¨èªªæ˜ v10.0ï¼š\\n\\n" +
                    "1ï¸âƒ£ ã€æ–°å¢è¡Œç¨‹ã€‘\\nç›´æ¥è²¼ä¸Šæ–‡å­—æˆ–åœ–ç‰‡ (æ”¯æ´è¡¨æ ¼ã€èŠå¤©è¨˜éŒ„)ã€‚\\nç¯„ä¾‹ï¼šã€Œ1/20 æ™šä¸Š7:30 é–‹æœƒã€\\n\\n" +
                    "2ï¸âƒ£ ã€æŸ¥è©¢è¡Œç¨‹ã€‘\\n" +
                    "â€¢ æŸ¥ç‰¹å®šæ—¥æœŸï¼šã€Œ1/20ã€\\n" +
                    "â€¢ æŸ¥æ•´æœˆä»½ï¼šã€Œ1æœˆã€\\n\\n" +
                    "3ï¸âƒ£ ã€åˆªé™¤è¡Œç¨‹ã€‘\\n" +
                    "â€¢ åˆªé™¤ï¼šã€Œåˆªé™¤ 1/20 é–‹æœƒã€";
    replyLine(replyToken, helpMsg);
    return true;
  }

  // åˆªé™¤
  if (lowerText.startsWith("åˆªé™¤") || lowerText.startsWith("å–æ¶ˆ")) {
     const delResult = deleteScheduleByCommand(text);
     replyLine(replyToken, delResult);
     return true;
  }

  // æŸ¥è©¢åˆ¤æ–·
  const isExplicitQuery = text.match(/(æŸ¥è©¢|è¡Œç¨‹|å®‰æ’|æœ‰ä»€éº¼|å¹¾è™Ÿ)/);
  const isShortDate = text.length < 10 && text.match(/(\\d{1,2}[/-]\\d{1,2}|\\d{1,2}æœˆ)/);
  const isKeyword = text.match(/^(ä»Šå¤©|æ˜å¤©|å¾Œå¤©)$/);

  if (isExplicitQuery || isShortDate || isKeyword) {
    const today = new Date();
    let targetDate = null;
    let queryMode = 'day'; 

    if (text.includes("ä»Šå¤©")) {
      targetDate = today;
    } else if (text.includes("æ˜å¤©")) {
      targetDate = new Date(today); targetDate.setDate(today.getDate() + 1);
    } else if (text.includes("å¾Œå¤©")) {
      targetDate = new Date(today); targetDate.setDate(today.getDate() + 2);
    } else {
      const dateMatch = text.match(/(\\d{1,2})\\s*[-/æœˆ]\\s*(\\d{1,2})/);
      const monthMatch = text.match(/(\\d{1,2})\\s*æœˆ/);
      const chiMonthMatch = text.match(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\\s*æœˆ/);

      if (dateMatch) {
         const m = parseInt(dateMatch[1]);
         const d = parseInt(dateMatch[2]);
         let y = today.getFullYear();
         if (today.getMonth() + 1 >= 11 && m <= 2) y++;
         targetDate = new Date(y, m - 1, d);
      } else if (monthMatch && !text.includes("æ—¥") && !text.includes("/")) {
         const m = parseInt(monthMatch[1]);
         let y = today.getFullYear();
         if (today.getMonth() + 1 >= 11 && m <= 2) y++;
         targetDate = new Date(y, m - 1, 1);
         queryMode = 'month';
      } else if (chiMonthMatch && !text.includes("æ—¥")) {
         const map = {'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'åä¸€':11,'åäºŒ':12};
         const m = map[chiMonthMatch[1]];
         if (m) {
             let y = today.getFullYear();
             if (today.getMonth() + 1 >= 11 && m <= 2) y++;
             targetDate = new Date(y, m - 1, 1);
             queryMode = 'month';
         }
      }
    }

    if (targetDate) {
      const result = searchSchedule(targetDate, queryMode);
      replyLine(replyToken, result);
      return true;
    }
  }

  return false;
}

function deleteScheduleByCommand(text) {
  const today = new Date();
  const dateMatch = text.match(/(\\d{1,2})\\s*[-/æœˆ]\\s*(\\d{1,2})/);
  
  if (!dateMatch) {
     return "âŒ åˆªé™¤å¤±æ•—ï¼šè«‹æŒ‡å®šæ—¥æœŸï¼Œä¾‹å¦‚ã€Œåˆªé™¤ 1/20ã€æˆ–ã€Œåˆªé™¤ 1/20 é–‹æœƒã€ã€‚";
  }

  const m = parseInt(dateMatch[1]);
  const d = parseInt(dateMatch[2]);
  let y = today.getFullYear();
  if (today.getMonth() + 1 >= 11 && m <= 2) y++;
  const targetDate = new Date(y, m - 1, d);
  
  let keyword = text.replace(/åˆªé™¤|å–æ¶ˆ/g, "").replace(dateMatch[0], "").replace("æ—¥", "").trim();

  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return "âŒ æ‰¾ä¸åˆ°è¡Œç¨‹è¡¨ã€‚";

  const data = sheet.getDataRange().getValues();
  let deletedCount = 0;
  let deletedInfo = "";

  for (let i = data.length - 1; i >= 1; i--) {
     const rowDate = new Date(data[i][4]);
     if (isNaN(rowDate.getTime())) continue;

     if (rowDate.getMonth() === targetDate.getMonth() && 
         rowDate.getDate() === targetDate.getDate() && 
         rowDate.getFullYear() === targetDate.getFullYear()) {
         
         const rowTitle = String(data[i][5]);
         if (keyword === "" || rowTitle.includes(keyword)) {
             sheet.deleteRow(i + 1);
             deletedCount++;
             deletedInfo += \`â€¢ \${rowTitle}\\n\`;
         }
     }
  }

  if (deletedCount > 0) {
     return \`ğŸ—‘ï¸ å·²åˆªé™¤ \${m}/\${d} çš„ \${deletedCount} ç­†è¡Œç¨‹ï¼š\\n\${deletedInfo}\`;
  } else {
     return \`âŒ æ‰¾ä¸åˆ° \${m}/\${d} \${keyword ? "å«æœ‰ã€Œ"+keyword+"ã€çš„" : ""}è¡Œç¨‹ã€‚\`;
  }
}

function searchSchedule(dateObj, mode) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return "âŒ å°šæœªå»ºç«‹è¡Œç¨‹è¡¨";

  const data = sheet.getDataRange().getValues();
  const results = [];
  const targetMonth = dateObj.getMonth();
  const targetDay = dateObj.getDate();
  const targetYear = dateObj.getFullYear();

  for (let i = 1; i < data.length; i++) {
    const rowDate = new Date(data[i][4]);
    if (isNaN(rowDate.getTime())) continue;

    let match = false;
    if (mode === 'month') {
      if (rowDate.getMonth() === targetMonth && rowDate.getFullYear() === targetYear) match = true;
    } else {
      if (rowDate.getMonth() === targetMonth && rowDate.getDate() === targetDay && rowDate.getFullYear() === targetYear) match = true;
    }

    if (match) {
      const timeStr = Utilities.formatDate(rowDate, Session.getScriptTimeZone(), "HH:mm");
      const dateStr = Utilities.formatDate(rowDate, Session.getScriptTimeZone(), "MM/dd");
      const title = data[i][5];
      const loc = data[i][6] ? \`(\${data[i][6]})\` : "";
      results.push({ date: dateStr, time: timeStr, title: title, loc: loc, sortTime: rowDate.getTime() });
    }
  }

  if (results.length === 0) {
    const modeStr = (mode === 'month') ? (targetMonth + 1) + "æœˆ" : (targetMonth + 1) + "/" + targetDay;
    return \`ğŸ“… \${modeStr} ç›®å‰æ²’æœ‰è¡Œç¨‹å–”ï¼\`;
  }

  results.sort((a, b) => a.sortTime - b.sortTime);

  let msg = (mode === 'month') ? \`ğŸ“… \${targetMonth + 1}æœˆ è¡Œç¨‹ä¸€è¦½ï¼š\\n\` : \`ğŸ“… \${targetMonth + 1}/\${targetDay} è¡Œç¨‹ï¼š\\n\`;
  results.forEach(item => {
    msg += \`----------------\\n[\${item.date} \${item.time}] \${item.title} \${item.loc}\\n\`;
  });

  return msg;
}

function processEventsBatch(userId, newEvents) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å°å­˜æ™‚é–“"]);
    sheet.setFrozenRows(1);
  }

  const existingData = sheet.getDataRange().getValues();
  const existingSignatures = new Set();
  
  for (let i = 1; i < existingData.length; i++) {
    const row = existingData[i];
    let rowTime = row[4];
    let rowTitle = row[5];
    if (!(rowTime instanceof Date)) { rowTime = new Date(rowTime); }
    
    if (!isNaN(rowTime.getTime())) {
       const timeStr = Utilities.formatDate(rowTime, Session.getScriptTimeZone(), "yyyy-MM-dd_HH:mm");
       existingSignatures.add(\`\${timeStr}_\${rowTitle}\`);
    }
  }

  const rowsToAdd = [];
  const addedEvents = [];
  const ignoredTitles = [];

  newEvents.forEach(event => {
    const eventTimeStr = Utilities.formatDate(event.startObj, Session.getScriptTimeZone(), "yyyy-MM-dd_HH:mm");
    const signature = \`\${eventTimeStr}_\${event.title}\`;

    if (existingSignatures.has(signature)) {
      ignoredTitles.push(event.title);
    } else {
      rowsToAdd.push([
        userId,
        event.date,
        event.timeStart,
        event.timeEnd,
        event.startObj,
        event.title,
        event.location,
        "", 
        new Date()
      ]);
      try { createCalendarEvent(event); } 
      catch (e) { Logger.log("æ—¥æ›†å¯«å…¥å¤±æ•—: " + e.message); }
      addedEvents.push(event);
      existingSignatures.add(signature);
    }
  });

  if (rowsToAdd.length > 0) {
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    SpreadsheetApp.flush(); 
    const fullRange = sheet.getDataRange();
    if (fullRange.getNumRows() > 1) {
       sheet.getRange(2, 1, fullRange.getNumRows() - 1, fullRange.getNumColumns()).sort({column: 5, ascending: true});
    }
  }

  return { added: addedEvents, ignored: ignoredTitles };
}

function handleImageOCR(messageId) {
  const url = \`https://api-data.line.me/v2/bot/message/\${messageId}/content\`;
  const response = UrlFetchApp.fetch(url, { 'headers': { 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN } });
  const blob = response.getBlob();
  const resource = { title: "temp_ocr_" + new Date().getTime(), mimeType: blob.getContentType() };
  let file, attempts = 0;
  const maxAttempts = 3; 
  while (attempts < maxAttempts) {
    try { file = Drive.Files.insert(resource, blob, { ocr: true }); break; } 
    catch (e) { 
      attempts++; 
      if(attempts >= maxAttempts) throw new Error("OCR æœå‹™å¿™ç¢Œ (" + e.message + ")ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      Utilities.sleep(1500); 
    }
  }
  const text = DocumentApp.openById(file.id).getBody().getText();
  try { Drive.Files.remove(file.id); } catch (e) {}
  return text;
}

// ---------------- è§£ææ ¸å¿ƒ V10.0 ----------------
function parseScheduleUltimate(text) {
  // 1. æ™šé–“é—œéµå­—
  text = text.replace(/(ä»Šæ™š|æ™šä¸Š|æ™šé–“)/g, "PM ");
  
  // 2. æ™ºæ…§æ–·è© (é¿é–‹å¹´æœˆæ—¥è™Ÿ)
  text = text.replace(/([^\då¹´æœˆæ—¥è™Ÿ\s])(\d)/g, "$1 $2")
             .replace(/(\d)([^\då¹´æœˆæ—¥è™Ÿ\s:ï¼š-])/g, "$1 $2");

  // 3. ç¬¦è™Ÿæ¸…ç†
  text = text.replace(/(\\d{4})[:](?=\\d{2})/g, "$1-")
             .replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
             .replace(/â‹…/g, " ").replace(/[()ï¼ˆï¼‰ã€ã€‘\\[\\]]/g, " ") 
             .replace(/[\\u0000-\\u0008\\u000B-\\u001F\\u007F]/g, "") 
             .replace(/æ—¥æœŸ[:ï¼š]/g, "").replace(/æ™‚é–“[:ï¼š]/g, ""); 
             
  text = text.replace(/ä¸Šåˆ/g, "AM ").replace(/ä¸‹åˆ/g, "PM ")
             .replace(/(AM|PM)[:ï¼š]?/gi, "$1 ");

  const lines = text.split('\\n').map(l => l.trim()).filter(l => l);
  const currentYear = new Date().getFullYear();
  const currentRealMonth = new Date().getMonth() + 1; 

  const datePattern = /(?:^|[^\\d:ï¼š])(?:(\\d{2,4})\s*[./å¹´-])?\s*(\\d{1,2})\s*[-./æœˆ]\s*(\\d{1,2})\s*([æ—¥è™Ÿ])?/g; 
  const monthHeaderPattern = /^(\\d{1,2})\\s*[æœˆ]/; 
  const dayOnlyPattern = /^(\\d{1,2})\\s*[æ—¥è™Ÿ](?!\\d)/; 

  let defaultTitle = "";
  let defaultTime = { startH: 9, startM: 0, endH: 10, endM: 0, valid: false };
  let contextMonth = null; 

  const results = [];
  
  for (let i = 0; i < lines.length; i++) {
     let line = lines[i];
     
     // æœˆä»½æ¨™é¡Œåµæ¸¬ (æ›´æ–°ä¸Šä¸‹æ–‡)
     const monthHeader = line.match(monthHeaderPattern);
     if (monthHeader) {
        contextMonth = parseInt(monthHeader[1]);
        if (line.length < 10) continue; 
     }

     let dateMatches = [];
     let match;
     
     // æŠ“å–æ¨™æº–æ—¥æœŸ (å«æ°‘åœ‹å¹´)
     datePattern.lastIndex = 0;
     while ((match = datePattern.exec(line)) !== null) {
        const pureNumber = match[0].trim().match(/^(\\d{3,4})$/);
        let yCandidate = parseInt(match[1]);
        let isROC = false;
        if (yCandidate < 1000) { yCandidate += 1911; isROC = true; }
        
        // åš´æ ¼å¹´é™: æ°‘åœ‹æˆ– 2020-2035
        if (!pureNumber && (isROC || !yCandidate || (yCandidate >= 2020 && yCandidate <= 2035))) {
           dateMatches.push({ m: parseInt(match[2]), d: parseInt(match[3]), src: match[0], y: yCandidate });
           contextMonth = parseInt(match[2]); 
        }
     }

     // æŠ“å–ç°¡å¯«æ—¥æœŸ (éœ€æœ‰ ContextMonth)
     if (dateMatches.length === 0 && contextMonth) {
        const dayMatch = line.match(dayOnlyPattern);
        if (dayMatch) {
           dateMatches.push({ m: contextMonth, d: parseInt(dayMatch[1]), src: dayMatch[0], y: currentYear });
        }
     }

     // è‹¥é€™è¡Œæ²’æ—¥æœŸ -> å˜—è©¦æå–å…¨åŸŸè³‡è¨Š
     if (dateMatches.length === 0) {
        if (results.length === 0) {
            const t = extractTimeFromLine(line);
            if (t.found) { defaultTime = t; defaultTime.valid = true; line = line.replace(t.raw, ""); }
            if (!line.match(/^(æé†’|é€šçŸ¥|å…¬å‘Š|ä»¥ä¸‹).+[:ï¼š~]$/) && !line.match(/https?:\\/\\//) && !line.match(/^(å…¶ä»–æ™‚é–“)/)) {
               defaultTitle += line + " ";
            }
        }
        continue;
     }

     // è§£æç•¶è¡Œå…§å®¹
     let localTime = extractTimeFromLine(line);
     let contentText = line;
     dateMatches.forEach(dm => { contentText = contentText.replace(dm.src, " "); });
     if (localTime.found) { contentText = contentText.replace(localTime.raw, " "); }
     if (monthHeader) contentText = contentText.replace(monthHeader[0], " ");

     // æ¨™é¡Œå¼·åŠ›æ·¨åŒ–
     let localTitle = contentText.replace(/^\\s*([(*]?\\d+[.)*\\]]?|[*â€¢-])\\s*/, "")
                                 .replace(/https?:\\/\\/[^\\s]+/g, "")
                                 .replace(/[é€±æ˜ŸæœŸ][ä¸€äºŒä¸‰å››äº”å…­æ—¥]/g, "") 
                                 .replace(/\\s+[ä¸€äºŒä¸‰å››äº”å…­æ—¥]\\s*$/g, "") 
                                 .replace(/\\s+[æ—¥è™Ÿ]\\s*$/g, "") 
                                 .trim();

     let localLocation = "";

     // å€å¡Šæƒæ (æ·±åº¦æ™‚é–“æœç´¢ + åœ°é»)
     let j = i + 1;
     while (j < lines.length) {
        let nextLine = lines[j];
        
        // é‡åˆ°ä¸‹ä¸€å€‹æ—¥æœŸå‰‡åœæ­¢
        let nextIsDate = false;
        if (datePattern.test(nextLine) || (contextMonth && dayOnlyPattern.test(nextLine)) || monthHeaderPattern.test(nextLine)) {
            nextIsDate = true;
        }
        if (nextIsDate) break;

        // æ·±åº¦æ™‚é–“æœç´¢ï¼šå¦‚æœé€™è¡Œæ˜¯æ™‚é–“ï¼Œä¸”æ¯”ç›®å‰çš„æ›´åƒ (æˆ–æ˜¯å€æ®µ)ï¼Œå°±ç”¨å®ƒ
        let potentialTime = extractTimeFromLine(nextLine);
        if (potentialTime.found) {
             // é‚è¼¯: è‹¥åŸç„¡æ™‚é–“ OR åŸç‚ºå–®é»ä¸”æ–°ç‚ºå€æ®µ -> æ›¿æ›
             if (!localTime.found || (localTime.startH === localTime.endH - 1 && potentialTime.startH !== potentialTime.endH - 1)) {
                 localTime = potentialTime;
             }
             let leftOver = nextLine.replace(potentialTime.raw, "").replace(/æ™‚é–“[:ï¼š]/, "").trim();
             if (leftOver) localLocation += " " + leftOver;
             j++;
             continue;
        }

        if (nextLine.match(/(åœ°é»|åœ°å€|ä½ç½®|æ•™å®¤|æœƒè­°å®¤|æ¨“|è™Ÿ|è·¯|è¡—|å€|å¸‚|ç¸£|http|å¤§æ¨“)/)) {
             localLocation += " " + nextLine;
        } else if (nextLine.match(/^(è¬›å¸«|è²»ç”¨|å°è±¡|è¬›é¡Œ)/)) {
             localLocation += " " + nextLine; 
        } else {
             localLocation += " " + nextLine; 
        }
        j++;
     }

     // æ•´åˆè³‡è¨Š
     defaultTitle = defaultTitle.trim();
     let finalTitle = localTitle ? (defaultTitle ? defaultTitle + " (" + localTitle + ")" : localTitle) : defaultTitle || "æœªå‘½åè¡Œç¨‹";
     if (localTitle.length > 5 && !defaultTitle) finalTitle = localTitle;
     
     localLocation = localLocation.trim();

     let sH = localTime.found ? localTime.startH : defaultTime.startH;
     let sM = localTime.found ? localTime.startM : defaultTime.startM;
     let eH = localTime.found ? localTime.endH : defaultTime.endH;
     let eM = localTime.found ? localTime.endM : defaultTime.endM;

     // ç”¢ç”Ÿäº‹ä»¶ç‰©ä»¶
     dateMatches.forEach(dm => {
        let y = dm.y || currentYear;
        // è‡ªå‹•è·¨å¹´ï¼šè‹¥æ²’æŒ‡å®šå¹´ä»½ & ç¾åœ¨å¹´åº• & ç›®æ¨™å¹´åˆ
        if (!dm.y && currentRealMonth >= 11 && dm.m <= 2) y++;
        
        // æ—¥æœŸç‰©ä»¶
        const startObj = new Date(y, dm.m - 1, dm.d, sH, sM, 0);
        const endObj = new Date(y, dm.m - 1, dm.d, eH, eM, 0);
        
        const mStr = String(dm.m).padStart(2, '0');
        const dStr = String(dm.d).padStart(2, '0');
        const dateStr = \`\${y}-\${mStr}-\${dStr}\`;

        results.push({
          date: dateStr,
          timeStart: \`\${String(sH).padStart(2,'0')}:\${String(sM).padStart(2,'0')}\`,
          timeEnd: \`\${String(eH).padStart(2,'0')}:\${String(eM).padStart(2,'0')}\`,
          startObj: startObj,
          endObj: endObj,
          title: finalTitle,
          location: localLocation 
        });
     });

     i = j - 1; 
  }

  return { status: 'success', data: results };
}

function extractTimeFromLine(line) {
  // 1. å€æ®µæ™‚é–“: 14:00-16:00, 1400-1600
  const complexTime = line.match(/(?:^|\\s|[:ï¼š\\-(])(\\d{1,2}:?\\d{2}|\\d{4})(:(\\d{2}))?\\s*[-~]\\s*(?:AM|PM\\s*)?(\\d{1,2}:?\\d{2}|\\d{4})(:(\\d{2}))?/i);
  // 2. å–®é»æ™‚é–“: 14:00, 14é»
  const singleTime = line.match(/(?:^|\\s|[:ï¼š\\-(])(\\d{1,2}:?\\d{2}|\\d{4})(:(\\d{2}))?(?:$|\\s|é»)/i);
  
  if (complexTime) {
     const parseRaw = (raw) => {
       raw = raw.replace(":", "");
       if (raw.length === 4) return { h: parseInt(raw.substring(0,2)), m: parseInt(raw.substring(2,4)) };
       if (raw.length <= 2) return { h: parseInt(raw), m: 0 };
       return { h: 9, m: 0 };
     };
     const s = parseRaw(complexTime[1]);
     const e = parseRaw(complexTime[4]); 
     let sh = s.h, sm = s.m, eh = e.h, em = e.m;
     if (line.match(/PM/i) && sh < 12) { sh += 12; if(eh < 12) eh += 12; }
     return { found: true, startH: sh, startM: sm, endH: eh, endM: em, raw: complexTime[0] };
  } else if (singleTime && !line.match(/[-~]/)) {
     let val = parseInt(singleTime[1].replace(":", ""));
     // æ’é™¤å¹´ä»½
     if (val < 2400 && (val > 2035 || val < 2020)) {
         let h=0, m=0;
         if (singleTime[1].includes(":") || singleTime[1].length === 4) {
            let raw = singleTime[1].replace(":", "");
            h = parseInt(raw.substring(0,2));
            m = parseInt(raw.substring(2,4));
         } else { h = parseInt(singleTime[1]); }
         
         if (line.match(/PM/i) && h < 12) h += 12;
         return { found: true, startH: h, startM: m, endH: h+1, endM: m, raw: singleTime[0] };
     }
  }
  return { found: false };
}

function createCalendarEvent(data) {
  CalendarApp.getCalendarById(CALENDAR_ID).createEvent(data.title, data.startObj, data.endObj, { description: \`åœ°é»/é€£çµ: \${data.location}\\n(æ™‚å…‰ç§˜æ›¸)\`, location: data.location });
}

function checkReminders() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return;
  const now = new Date();
  if (now.getHours() === 4 && now.getMinutes() < 15) { performDailyMaintenance(ss, sheet); }
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  const maxReminderMin = Math.max(...REMINDER_OFFSETS);
  const maxLookAheadTime = new Date(now.getTime() + (maxReminderMin + 60) * 60 * 1000); 
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const userId = row[0];
    const eventTime = new Date(row[4]); 
    const title = row[5];
    const location = row[6];
    let notifiedStatus = row[7] ? String(row[7]) : ""; 
    if (eventTime > maxLookAheadTime) { break; }
    let needUpdate = false;
    REMINDER_OFFSETS.forEach(offsetMin => {
      if (notifiedStatus.includes(\`|\${offsetMin}|\`)) return;
      const timeDiffMin = (eventTime.getTime() - now.getTime()) / 60000;
      if (timeDiffMin <= offsetMin && timeDiffMin > (offsetMin - 20)) {
        let timeLabel = "";
        if (offsetMin >= 1440) timeLabel = \`å‰ \${Math.floor(offsetMin/1440)} å¤©\`;
        else if (offsetMin >= 60) timeLabel = \`å‰ \${(offsetMin/60).toFixed(1).replace('.0','')} å°æ™‚\`;
        else timeLabel = \`å‰ \${offsetMin} åˆ†é˜\`;
        const msg = \`â° æé†’ (\${timeLabel})ï¼šæ´»å‹•å³å°‡é–‹å§‹ï¼\\n\\nä¸»é¡Œï¼š\${title}\\næ™‚é–“ï¼š\${Utilities.formatDate(eventTime, Session.getScriptTimeZone(), "HH:mm")}\\nåœ°é»/é€£çµï¼š\${location}\`;
        pushLineMessage(userId, msg);
        notifiedStatus += \`|\${offsetMin}|\`;
        needUpdate = true;
      }
    });
    if (needUpdate) { sheet.getRange(i + 1, 8).setValue(notifiedStatus); }
  }
}

function performDailyMaintenance(ss, sheet) {
  let historySheet = ss.getSheetByName(HISTORY_SHEET_NAME);
  if (!historySheet) { historySheet = ss.insertSheet(HISTORY_SHEET_NAME).appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å°å­˜æ™‚é–“"]); }
  const values = sheet.getDataRange().getValues();
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
  for (let i = values.length - 1; i >= 1; i--) {
    const eventTime = new Date(values[i][4]);
    if (eventTime < yesterday) {
      historySheet.appendRow([...values[i], new Date()]);
      sheet.deleteRow(i + 1);
    }
  }
}

// è¨Šæ¯é•·åº¦é˜²è­· (Truncate message)
function replyLine(replyToken, text) {
  if (text.length > 4000) {
    text = text.substring(0, 4000) + "...(å…§å®¹éé•·å·²æˆªæ–·)";
  }
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post', 'payload': JSON.stringify({ replyToken: replyToken, messages: [{ type: 'text', text: text }] })
  });
}

function pushLineMessage(userId, text) {
  if (text.length > 4000) {
    text = text.substring(0, 4000) + "...(å…§å®¹éé•·å·²æˆªæ–·)";
  }
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post', 'payload': JSON.stringify({ to: userId, messages: [{ type: 'text', text: text }] })
  });
}
`;

        function generateCode() {
            const token = document.getElementById('inputToken').value.trim();
            const sheetId = document.getElementById('inputSheetId').value.trim();
            
            let reminders = [60]; 
            const r1Val = document.getElementById('rem1_val').value;
            const r1Unit = document.getElementById('rem1_unit').value;
            if (r1Val && !isNaN(r1Val) && parseInt(r1Val) > 0) { reminders.push(parseInt(r1Val) * parseInt(r1Unit)); }
            const r2Val = document.getElementById('rem2_val').value;
            const r2Unit = document.getElementById('rem2_unit').value;
            if (r2Val && !isNaN(r2Val) && parseInt(r2Val) > 0) { reminders.push(parseInt(r2Val) * parseInt(r2Unit)); }
            reminders = [...new Set(reminders)].sort((a,b) => a - b);
            const reminderArrayStr = JSON.stringify(reminders);

            if (!token || !sheetId) { alert("è«‹å…ˆè¼¸å…¥ LINE Token èˆ‡ Google Sheet ID å–”ï¼"); return; }

            let finalCode = gasTemplate.replace('{{TOKEN}}', token).replace('{{SHEET_ID}}', sheetId).replace('{{REMINDER_ARRAY}}', reminderArrayStr);
            const outputArea = document.getElementById('outputCode');
            outputArea.value = finalCode;
            const resultSection = document.getElementById('resultSection');
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('copyStatus').classList.add('hidden');
        }

        function copyCode() {
            const outputArea = document.getElementById('outputCode');
            outputArea.select();
            document.execCommand('copy');
            const status = document.getElementById('copyStatus');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>