<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚å…‰ç§˜æ›¸ - è‡ªå‹•åŒ–è¡Œç¨‹åŠ©ç†ç”¢ç”Ÿå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-blue-600 text-white p-6 shadow-md">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold"><i class="fa-solid fa-robot mr-2"></i>æ™‚å…‰ç§˜æ›¸ (Chrono-Secretary)</h1>
                <p class="text-blue-100 text-sm mt-1">v5.1 å®Œç¾çµ‚æ¥µç‰ˆ</p>
            </div>
            <div class="text-3xl opacity-20"><i class="fa-regular fa-calendar-check"></i></div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6 space-y-8">

        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘‹ v5.1 å®Œç¾çµ‚æ¥µç‰ˆ</h2>
            <p class="text-gray-600 leading-relaxed mb-4">
                ä¿®æ­£äº†é€£çºŒè¡Œç¨‹æ¨™é¡Œå¯èƒ½æ²¾é»çš„å•é¡Œï¼Œçµåˆäº†çµæ§‹åŒ–åˆ†æèˆ‡æ™ºæ…§å‰è¦–æŠ€è¡“ï¼Œæ˜¯ç›®å‰æœ€ç©©å®šã€æº–ç¢ºçš„ç‰ˆæœ¬ã€‚
            </p>
            <ul class="list-disc list-inside space-y-2 text-gray-600 ml-2">
                <li>ğŸ‘€ <b>æ™ºæ…§æ–·å¥ï¼š</b>è‡ªå‹•é åˆ¤ä¸‹ä¸€è¡Œæ˜¯å¦ç‚ºæ—¥æœŸï¼Œç²¾æº–åˆ‡å‰²æ¨™é¡Œèˆ‡å…§å®¹ã€‚</li>
                <li>âš¡ <b>éåŒæ­¥æ¶æ§‹ï¼š</b>ç§’å›ã€Œè™•ç†ä¸­ã€ï¼Œå¾Œå°é‹ç®—å®Œæ¨æ’­çµæœï¼Œçµ•ä¸é€¾æ™‚ã€‚</li>
                <li>ğŸ“Š <b>å¼·åˆ¶æ’åºï¼š</b>å¯«å…¥å¾Œå¼·åˆ¶å­˜æª”ä¸¦æ’åºã€‚</li>
                <li>ğŸ›¡ï¸ <b>å®Œæ•´é˜²è­·ï¼š</b>OCR é‡è©¦ã€ç²¾æº–é˜²é‡è¤‡ã€æ°‘åœ‹å¹´æ”¯æ´ã€‚</li>
            </ul>
        </section>

        <!-- æ­¥é©Ÿ 1: LINE è¨­å®š -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">1</div>
                <h2 class="text-xl font-bold text-gray-800">å»ºç«‹ LINE å®˜æ–¹å¸³è™Ÿèˆ‡å–å¾— Token</h2>
            </div>
            <div class="pl-10 space-y-6 text-sm text-gray-600">
                <div>
                    <h3 class="font-bold text-blue-700 mb-2"><i class="fa-solid fa-key mr-1"></i> å–å¾— Channel Access Token</h3>
                    <ul class="list-decimal ml-5 space-y-2">
                        <li>å‰å¾€ <a href="https://developers.line.biz/zh-hant/" target="_blank" class="text-blue-600 hover:underline font-bold">LINE Developers Console</a>ã€‚</li>
                        <li>åœ¨ <b>Messaging API</b> åˆ†é æœ€ä¸‹æ–¹ç”¢ç”Ÿ Tokenã€‚</li>
                        <li>è¨˜å¾—é—œé–‰ <b>Auto-reply messages (è‡ªå‹•å›æ‡‰)</b>ã€‚</li>
                    </ul>
                </div>
            </div>
            <div class="mt-6 pl-10 border-t pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ‚¨çš„ Channel Access Tokenï¼š</label>
                <input type="text" id="inputToken" placeholder="ä¾‹å¦‚ï¼šeyJhbGciOiJIUzI1NiJ9..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            </div>
        </section>

        <!-- æ­¥é©Ÿ 2: Google Sheet è¨­å®š -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">2</div>
                <h2 class="text-xl font-bold text-gray-800">æº–å‚™ Google Sheet</h2>
            </div>
            <div class="pl-10 space-y-3 text-sm text-gray-600">
                <p>1.å»ºç«‹ä¸€å€‹æ–°çš„ <a href="https://sheets.new" target="_blank" class="text-blue-600 hover:underline">Google Sheet</a>ã€‚</p>
                <p>2.è¤‡è£½ç¶²å€åˆ—ä¸­çš„ IDã€‚</p>
            </div>
            <div class="mt-4 pl-10">
                <label class="block text-sm font-medium text-gray-700 mb-1">è²¼ä¸Šæ‚¨çš„ Google Sheet IDï¼š</label>
                <input type="text" id="inputSheetId" placeholder="ä¾‹å¦‚ï¼š1qo5L0zcjQweI7xV8cqE-3BByS0PMq-d6aAVfQzs20bo" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
            </div>
        </section>

        <!-- æ­¥é©Ÿ 3: è¨­å®šæé†’é€šçŸ¥ -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">3</div>
                <h2 class="text-xl font-bold text-gray-800">è¨­å®šæé†’é€šçŸ¥æ™‚é–“ (å¯é¸)</h2>
            </div>
            <div class="pl-10 text-sm text-gray-600">
                <p class="mb-4">é™¤äº†åŸºæœ¬çš„ 1 å°æ™‚å‰é€šçŸ¥ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å¢åŠ é¡å¤–çš„æé†’æ™‚é–“ã€‚</p>
                
                <div class="space-y-4">
                    <div class="flex items-center p-3 bg-gray-100 rounded border border-gray-300">
                        <i class="fa-solid fa-lock text-gray-400 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">åŸºæœ¬æé†’</span>
                        <span class="text-blue-600 font-bold bg-blue-100 px-2 py-1 rounded text-xs">å‰ 1 å°æ™‚</span>
                    </div>

                    <div class="flex items-center p-3 bg-white rounded border border-gray-300 hover:border-blue-400 transition">
                        <i class="fa-regular fa-bell text-blue-500 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">é¡å¤–æé†’ 1</span>
                        <span class="mr-2 text-gray-500 text-xs">å‰</span>
                        <input type="number" id="rem1_val" placeholder="0" class="w-20 p-1 border border-gray-300 rounded text-center focus:ring-1 focus:ring-blue-500 outline-none">
                        <select id="rem1_unit" class="ml-2 p-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 outline-none bg-white">
                            <option value="1">åˆ†é˜</option>
                            <option value="60">å°æ™‚</option>
                            <option value="1440">å¤©</option>
                        </select>
                    </div>

                    <div class="flex items-center p-3 bg-white rounded border border-gray-300 hover:border-blue-400 transition">
                        <i class="fa-regular fa-bell text-blue-500 mr-3"></i>
                        <span class="font-bold text-gray-700 w-24">é¡å¤–æé†’ 2</span>
                        <span class="mr-2 text-gray-500 text-xs">å‰</span>
                        <input type="number" id="rem2_val" placeholder="0" class="w-20 p-1 border border-gray-300 rounded text-center focus:ring-1 focus:ring-blue-500 outline-none">
                        <select id="rem2_unit" class="ml-2 p-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 outline-none bg-white">
                            <option value="1">åˆ†é˜</option>
                            <option value="60">å°æ™‚</option>
                            <option value="1440">å¤©</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç”¢ç”Ÿç¨‹å¼ç¢¼æŒ‰éˆ• -->
        <section class="bg-blue-50 p-6 rounded-lg shadow-sm border border-blue-200 text-center">
            <h2 class="text-xl font-bold text-blue-800 mb-2">ç”¢ç”Ÿæ‚¨çš„å°ˆå±¬ç¨‹å¼ç¢¼</h2>
            <button onclick="generateCode()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ä¸€éµç”¢ç”Ÿä»£ç¢¼
            </button>
        </section>

        <!-- çµæœé¡¯ç¤ºå€ -->
        <section id="resultSection" class="hidden bg-white p-6 rounded-lg shadow-lg border-2 border-blue-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">æ‚¨çš„ GAS ç¨‹å¼ç¢¼ (v5.1)</h3>
                <button onclick="copyCode()" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 py-1 px-3 rounded border border-gray-300 transition flex items-center">
                    <i class="fa-regular fa-copy mr-2"></i>è¤‡è£½ä»£ç¢¼
                </button>
            </div>
            <textarea id="outputCode" readonly class="w-full h-64 p-3 bg-gray-900 text-green-400 font-mono text-xs rounded shadow-inner focus:outline-none resize-y"></textarea>
            <p id="copyStatus" class="text-green-600 text-sm mt-2 hidden text-right"><i class="fa-solid fa-check mr-1"></i>å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼</p>
        </section>

        <!-- æ­¥é©Ÿ 4: GAS éƒ¨ç½² -->
        <section class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex items-center mb-4">
                <div class="step-number" style="width: 2rem; height: 2rem; background-color: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 0.75rem;">4</div>
                <h2 class="text-xl font-bold text-gray-800">éƒ¨ç½² Google Apps Script</h2>
            </div>
            <div class="pl-10 space-y-4 text-sm text-gray-600">
                <ol class="list-decimal list-outside ml-4 space-y-3">
                    <li>å‰å¾€ Google Sheet > <b>æ“´å……åŠŸèƒ½</b> > <b>Apps Script</b>ï¼Œè²¼ä¸Šä»£ç¢¼ã€‚</li>
                    <li>
                        <span class="font-bold text-red-600">é–‹å•Ÿ Drive API v2 (æœå‹™ > + > Drive API > v2)ã€‚</span>
                    </li>
                    <li>
                        åŸ·è¡Œ <code>initialSetup</code> å‡½å¼ä¸¦å®Œæˆæˆæ¬Šã€‚
                    </li>
                    <li class="bg-yellow-50 p-2 rounded border-l-4 border-yellow-400">
                        <span class="font-bold text-yellow-800">ã€éå¸¸é‡è¦ã€‘å»ºç«‹æ–°ç‰ˆæœ¬ï¼š</span>
                        <br>æ¯æ¬¡æ›´æ–°ç¨‹å¼ç¢¼å¾Œï¼Œä¸€å®šè¦é»æ“Š <b>éƒ¨ç½²</b> > <b>ç®¡ç†éƒ¨ç½²</b> > é»æ“Šç­†åœ–ç¤º > ç‰ˆæœ¬é¸æ“‡ <b>ã€Œæ–°ç‰ˆæœ¬ã€</b> > <b>éƒ¨ç½²</b>ã€‚
                    </li>
                    <li>
                        <b>è¨­å®šè§¸ç™¼å™¨ï¼š</b>
                        <ul class="list-disc ml-5 mt-1 text-gray-500">
                            <li>æ–°å¢è§¸ç™¼æ¢ä»¶ï¼š<code>checkReminders</code> / æ™‚é–“é©…å‹• / åˆ†é˜è¨ˆæ™‚å™¨ / <b>æ¯ 15 åˆ†é˜</b>ã€‚</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </section>

    </main>

    <footer class="bg-gray-100 text-center p-6 text-sm text-gray-500 mt-8">
        <p>&copy; 2026 æ™‚å…‰ç§˜æ›¸å°ˆæ¡ˆ</p>
    </footer>

    <script>
        const gasTemplate = `/**
 * å°ˆæ¡ˆåç¨±ï¼šæ™‚å…‰ç§˜æ›¸ (Chrono-Secretary) v5.1 (å®Œç¾çµ‚æ¥µç‰ˆ)
 * åŠŸèƒ½ï¼šæ™ºæ…§æ¨¡ç³Šè§£æ LINE è¨Šæ¯ -> Google Sheet -> LINE é€šçŸ¥
 * æ›´æ–°ï¼š
 * 1. æ ¸å¿ƒå‡ç´šï¼šçµæ§‹åŒ–åˆ†æ + æ™ºæ…§å‰è¦– (Lookahead)ï¼Œè§£æ±ºæ¨™é¡Œæ²¾é»èˆ‡æ¼æŠ“å•é¡Œ
 * 2. æ¶æ§‹ï¼šéåŒæ­¥å›æ‡‰ (é˜²é€¾æ™‚) + å¼·åˆ¶æ’åº + ç²¾æº–é˜²é‡è¤‡
 */

// ================= è¨­å®šå€ (ç”±ç¶²é ç”¢ç”Ÿå™¨è‡ªå‹•å¡«å…¥) =================
const CHANNEL_ACCESS_TOKEN = '{{TOKEN}}'; 
const SHEET_ID = '{{SHEET_ID}}'; 
const CALENDAR_ID = 'primary'; 
const SHEET_NAME = 'è¡Œç¨‹è¨˜éŒ„'; 
const HISTORY_SHEET_NAME = 'æ­·å²å°å­˜';

// [é‡è¦] æé†’æ™‚é–“è¨­å®š
const REMINDER_OFFSETS = {{REMINDER_ARRAY}}; 

function doGet(e) { return ContentService.createTextOutput("æœå‹™æ­£å¸¸é‹ä½œä¸­ (v5.1 å®Œç¾çµ‚æ¥µç‰ˆ)ï¼"); }

function initialSetup() {
  const user = Session.getActiveUser().getEmail();
  Logger.log(\`ä½¿ç”¨è€… \${user} æª¢æŸ¥æ¬Šé™...\`);
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    if (!ss.getSheetByName(HISTORY_SHEET_NAME)) {
      ss.insertSheet(HISTORY_SHEET_NAME).appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å°å­˜æ™‚é–“"]);
    }
    Logger.log("âœ… è©¦ç®—è¡¨æ¬Šé™ OK");
  } catch (e) { Logger.log("âŒ è©¦ç®—è¡¨éŒ¯èª¤: " + e.message); }
  try { CalendarApp.getCalendarById(CALENDAR_ID); Logger.log("âœ… æ—¥æ›†æ¬Šé™ OK"); } catch (e) { Logger.log("âŒ æ—¥æ›†éŒ¯èª¤: " + e.message); }
  try { 
    const tempFile = DriveApp.createFile("temp_auth_check.txt", "Auth Check"); 
    tempFile.setTrashed(true); Logger.log("âœ… Drive å¯«å…¥æ¬Šé™ OK"); 
  } catch (e) { Logger.log("âŒ Drive å¯«å…¥æ¬Šé™å¤±æ•—: " + e.message); }
  Logger.log("ğŸ‰ æ¬Šé™æª¢æŸ¥å®Œæˆï¼è«‹é€²è¡Œéƒ¨ç½²ã€‚");
}

function doPost(e) {
  if (!e || !e.postData) return;
  const msgObj = JSON.parse(e.postData.contents);
  if (!msgObj.events || msgObj.events.length === 0) return;
  const event = msgObj.events[0];
  const replyToken = event.replyToken;
  const userId = event.source.userId;
  
  if (event.type === 'message') {
    let userMessage = "";
    
    // Step 1: ç«‹å³å›è¦†é¿å… Timeout
    if (event.message.type === 'image') {
      try {
        replyLine(replyToken, "ğŸ” æ”¶åˆ°åœ–ç‰‡ï¼Œæ­£åœ¨é€²è¡Œ AI è¾¨è­˜èˆ‡æ•´ç†... (è«‹ç¨å€™)");
      } catch (e) {
        Logger.log("Reply failed: " + e.message);
      }
      
      try {
        userMessage = handleImageOCR(event.message.id);
        if (!userMessage.trim()) { 
          pushLineMessage(userId, "âŒ åœ–ç‰‡è¾¨è­˜å¤±æ•—ï¼Œç„¡æ³•è®€å–æ–‡å­—ã€‚"); 
          return; 
        }
      } catch (err) {
        pushLineMessage(userId, "âŒ è™•ç†éŒ¯èª¤ï¼š" + err.message);
        return;
      }
    } else if (event.message.type === 'text') {
      userMessage = event.message.text;
    } else {
      return; 
    }

    // Step 3: è§£æèˆ‡å¯«å…¥
    if (userMessage) {
      try {
        // [v5.1] ä½¿ç”¨çµ‚æ¥µç‰ˆè§£æå™¨
        const result = parseScheduleV5(userMessage);
        
        if (result.status === 'error') {
           if (event.message.type === 'image') { pushLineMessage(userId, "âŒ " + result.message); }
           else { replyLine(replyToken, "âŒ " + result.message); }
           return;
        }

        const parsedData = result.data;
        if (parsedData.length > 0) {
          const batchResult = processEventsBatch(userId, parsedData);
          
          let replyMsg = "âœ… è¡Œç¨‹å·²å®‰æ’ä¸¦æ’åºï¼š\\n";
          
          batchResult.added.forEach(data => {
             const startStr = Utilities.formatDate(data.startObj, Session.getScriptTimeZone(), "MM/dd HH:mm");
             const endStr = Utilities.formatDate(data.endObj, Session.getScriptTimeZone(), "HH:mm");
             replyMsg += \`----------------\\nğŸ“… \${startStr} - \${endStr}\\nğŸ“ \${data.title}\\nğŸ“ \${data.location || 'ç·šä¸Š/ç„¡åœ°é»'}\\n\`;
          });

          batchResult.ignored.forEach(title => {
             replyMsg += \`----------------\\n(å·²å¿½ç•¥é‡è¤‡è¡Œç¨‹ï¼š\${title})\\n\`;
          });
          
          if (batchResult.added.length > 0) {
            const reminderText = REMINDER_OFFSETS.map(min => {
              if (min >= 1440) return \`å‰ \${Math.floor(min/1440)} å¤©\`;
              if (min >= 60) return \`å‰ \${(min/60).toFixed(1).replace('.0','')} å°æ™‚\`;
              return \`å‰ \${min} åˆ†é˜\`;
            }).join("ã€");
            replyMsg += \`\\nğŸ”” æ©Ÿå™¨äººå°‡åœ¨æ´»å‹• \${reminderText} é€šçŸ¥æ‚¨ã€‚\`;
          } else if (batchResult.ignored.length > 0 && batchResult.added.length === 0) {
            replyMsg += "\\n(æ‰€æœ‰è¡Œç¨‹å‡å·²å­˜åœ¨ï¼Œç„¡éœ€æ–°å¢)";
          }
          
          if (event.message.type === 'image') { 
            pushLineMessage(userId, replyMsg); 
          } else { 
            replyLine(replyToken, replyMsg); 
          }
        } else {
           const msg = "ç„¡æ³•è¾¨è­˜è¡Œç¨‹ã€‚è«‹ç¢ºèªå«æœ‰æ—¥æœŸ(å¦‚1/9)èˆ‡æ™‚é–“ã€‚";
           if (event.message.type === 'image') pushLineMessage(userId, msg);
           else replyLine(replyToken, msg);
        }
      } catch (err) {
        Logger.log(err);
        const errMsg = "âŒ ç³»çµ±éŒ¯èª¤ï¼š" + err.message;
        if (event.message.type === 'image') pushLineMessage(userId, errMsg);
        else replyLine(replyToken, errMsg);
      }
    }
  }
}

function processEventsBatch(userId, newEvents) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
    sheet.appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å»ºç«‹æ™‚é–“"]);
    sheet.setFrozenRows(1);
  }

  const existingData = sheet.getDataRange().getValues();
  const existingSignatures = new Set();
  
  for (let i = 1; i < existingData.length; i++) {
    const row = existingData[i];
    let rowTime = row[4];
    if (!(rowTime instanceof Date)) { rowTime = new Date(rowTime); }
    
    if (!isNaN(rowTime.getTime())) {
       const timeKey = Math.floor(rowTime.getTime() / 60000);
       existingSignatures.add(\`\${timeKey}_\${row[5]}\`);
    }
  }

  const rowsToAdd = [];
  const addedEvents = [];
  const ignoredTitles = [];

  newEvents.forEach(event => {
    const eventTimeKey = Math.floor(event.startObj.getTime() / 60000);
    const signature = \`\${eventTimeKey}_\${event.title}\`;

    if (existingSignatures.has(signature)) {
      ignoredTitles.push(event.title);
    } else {
      rowsToAdd.push([
        userId,
        event.date,
        event.timeStart,
        event.timeEnd,
        event.startObj,
        event.title,
        event.location,
        "", 
        new Date()
      ]);
      try { createCalendarEvent(event); } 
      catch (e) { Logger.log("æ—¥æ›†å¯«å…¥å¤±æ•—: " + e.message); }
      addedEvents.push(event);
      existingSignatures.add(signature);
    }
  });

  if (rowsToAdd.length > 0) {
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    SpreadsheetApp.flush(); 
    
    const fullRange = sheet.getDataRange();
    if (fullRange.getNumRows() > 1) {
       sheet.getRange(2, 1, fullRange.getNumRows() - 1, fullRange.getNumColumns()).sort({column: 5, ascending: true});
    }
  }

  return { added: addedEvents, ignored: ignoredTitles };
}

function handleImageOCR(messageId) {
  const url = \`https://api-data.line.me/v2/bot/message/\${messageId}/content\`;
  const response = UrlFetchApp.fetch(url, { 'headers': { 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN } });
  const blob = response.getBlob();
  const resource = { title: "temp_ocr_" + new Date().getTime(), mimeType: blob.getContentType() };
  let file, attempts = 0;
  const maxAttempts = 3; 
  while (attempts < maxAttempts) {
    try { file = Drive.Files.insert(resource, blob, { ocr: true }); break; } 
    catch (e) { 
      attempts++; 
      if(attempts >= maxAttempts) throw new Error("OCR æœå‹™å¿™ç¢Œ (" + e.message + ")ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      Utilities.sleep(1500); 
    }
  }
  const text = DocumentApp.openById(file.id).getBody().getText();
  try { Drive.Files.remove(file.id); } catch (e) {}
  return text;
}

// [v5.1 æ ¸å¿ƒ] çµæ§‹åŒ–åˆ¤è®€ + æ™ºæ…§å‰è¦–
function parseScheduleV5(text) {
  // 1. é è™•ç†
  text = text.replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/â‹…/g, " ").replace(/[()ï¼ˆï¼‰]/g, " ");
  
  // æå– URL
  const urlRegex = /(https?:\\/\\/[^\\s]+)/g;
  const links = text.match(urlRegex) || [];
  let linkIndex = 0;

  // åˆ‡å‰²è¡Œ
  const lines = text.split('\\n').map(l => l.trim()).filter(l => l);
  const currentYear = new Date().getFullYear();
  const results = [];

  // --- éšæ®µä¸€ï¼šæƒæå…¨çµæ§‹ (æ‰¾å‡ºæ‰€æœ‰æ—¥æœŸéŒ¨é») ---
  const eventsMap = []; 
  
  // è‡¨æ™‚è®Šæ•¸
  let currentGroup = null;
  let orphans = []; 

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.match(/^https?:\\/\\//) || line.match(/^(æ™‚é–“|æ—¥æœŸ|è¡Œç¨‹è¡¨|July|è¬›å¸«)/i)) continue;

    // æ™‚é–“é˜²å‘†
    const pureNumber = line.match(/^(\\d{3,4})$/);
    if (pureNumber) {
       const val = parseInt(pureNumber[1]);
       const isYear = (val >= 2020 && val <= 2035) || (val >= 100 && val <= 199);
       if (!isYear) { continue; } 
    }

    // æ—¥æœŸåµæ¸¬ (éŒ¨é»)
    const dateMatch = line.match(/(\\d{2,4})?\\s*[-./å¹´]\\s*(\\d{1,2})\\s*[-./æœˆ]\\s*(\\d{1,2})æ—¥?/);
    const looksLikeTime = line.match(/\\d{1,2}\\s*[-~]\\s*\\d{1,2}/);

    if (dateMatch && !looksLikeTime) {
      // ç™¼ç¾æ–°æ—¥æœŸéŒ¨é»
      let y = dateMatch[1] ? parseInt(dateMatch[1]) : currentYear;
      if (y < 1000) y += 1911; 
      const m = String(dateMatch[2]).padStart(2, '0');
      const d = String(dateMatch[3]).padStart(2, '0');
      const dateStr = \`\${y}-\${m}-\${d}\`;

      // å»ºç«‹æ–°äº‹ä»¶ç¾¤çµ„
      currentGroup = {
        date: dateStr,
        lines: [],
        timeInfo: null
      };
      
      // [é—œéµä¿®æ­£] æª¢æŸ¥ orphans æ‡‰è©²æ­¸å±¬çµ¦èª°
      if (orphans.length > 0) {
         // é€™è£¡çš„ orphan æ¥µå¤§æ©Ÿç‡æ˜¯é€™å€‹æ–°æ—¥æœŸçš„æ¨™é¡Œ (Title before Date)
         currentGroup.lines.push(...orphans);
         orphans = [];
      }

      // å¦‚æœæ—¥æœŸè¡Œæœ¬èº«é‚„æœ‰å‰©é¤˜æ–‡å­— (å¦‚ 1/1 æ–°å¹´)ï¼Œä¹ŸåŠ å…¥
      const remainingText = line.replace(dateMatch[0], "").trim();
      if (remainingText) currentGroup.lines.push(remainingText);

      eventsMap.push(currentGroup);

    } else {
      // ä¸æ˜¯æ—¥æœŸ
      if (currentGroup) {
        // [v5.1 æ™ºæ…§æ–·å¥] æª¢æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦ç‚ºæ—¥æœŸ
        // å¦‚æœä¸‹ä¸€è¡Œæ˜¯æ—¥æœŸï¼Œé€™è¡Œå°±ä¸èƒ½æ­¸çµ¦ currentGroupï¼Œè€Œè¦è®Šæˆ orphan (ä¸‹ä¸€å€‹ç¾¤çµ„çš„æ¨™é¡Œ)
        let nextLineIsDate = false;
        if (i + 1 < lines.length) {
           const nextLine = lines[i+1];
           const nextDateMatch = nextLine.match(/(\\d{2,4})?\\s*[-./å¹´]\\s*(\\d{1,2})\\s*[-./æœˆ]\\s*(\\d{1,2})æ—¥?/);
           const nextLooksLikeTime = nextLine.match(/\\d{1,2}\\s*[-~]\\s*\\d{1,2}/);
           if (nextDateMatch && !nextLooksLikeTime) {
              nextLineIsDate = true;
           }
        }

        if (nextLineIsDate) {
           orphans.push(line); // é€™æ˜¯ä¸‹ä¸€å€‹è¡Œç¨‹çš„æ¨™é¡Œ
        } else {
           currentGroup.lines.push(line); // é€™æ˜¯ç•¶å‰è¡Œç¨‹çš„å…§å®¹
        }
      } else {
        // é‚„æ²’æœ‰æ—¥æœŸï¼Œæš«å­˜ç‚ºå­¤å…’ (å¯èƒ½æ˜¯æ¨™é¡Œåœ¨æ—¥æœŸä¸Šé¢)
        orphans.push(line);
      }
    }
  }

  // --- éšæ®µäºŒï¼šè§£ææ¯å€‹ç¾¤çµ„ ---
  eventsMap.forEach(group => {
    let title = "";
    let startH = 9, startM = 0, endH = 10, endM = 0;
    let location = "";
    let foundTime = false;

    group.lines.forEach(line => {
      // 1. æ‰¾æ™‚é–“
      const complexTime = line.match(/(?:^|\\s)(\\d{1,2}|\\d{4})(:(\\d{2}))?\\s*[-~]\\s*(\\d{1,2}|\\d{4})(:(\\d{2}))?/);
      const singleTime = line.match(/(?:^|\\s)(\\d{1,2}|\\d{4})(:(\\d{2}))?(?:$|\\s|é»)/);
      const allDayMatch = line.match(/(æ•´å¤©|å…¨å¤©)/);
      const halfDayMatch = line.match(/(ä¸Šåˆ|ä¸‹åˆ)?\\s*åŠå¤©/);

      if (!foundTime) {
        if (complexTime) {
           let sRaw = complexTime[1];
           if (sRaw.length === 4) { startH = parseInt(sRaw.substring(0,2)); startM = parseInt(sRaw.substring(2,4)); } 
           else { startH = parseInt(sRaw); startM = complexTime[3] ? parseInt(complexTime[3]) : 0; }
           let eRaw = complexTime[4];
           if (eRaw.length === 4) { endH = parseInt(eRaw.substring(0,2)); endM = parseInt(eRaw.substring(2,4)); } 
           else { endH = parseInt(eRaw); endM = complexTime[6] ? parseInt(complexTime[6]) : 0; }
           foundTime = true;
           line = line.replace(complexTime[0], "").trim(); // æ¶ˆè²»æ‰æ™‚é–“
        } else if (singleTime && !line.match(/[-~]/)) { 
           let val = parseInt(singleTime[1]);
           if ((singleTime[1].length === 4 && val < 2400) || singleTime[1].length <= 2) {
             if (singleTime[1].length === 4) { startH = parseInt(singleTime[1].substring(0,2)); startM = parseInt(singleTime[1].substring(2,4)); }
             else { startH = val; startM = singleTime[3] ? parseInt(singleTime[3]) : 0; }
             endH = startH + 1; endM = startM;
             foundTime = true;
             location += "(æœªæŒ‡å®šçµæŸæ™‚é–“)"; // æ¨™è¨»
             line = line.replace(singleTime[0], "").trim();
           }
        } else if (allDayMatch) { 
           startH = 9; endH = 18; foundTime = true; 
           line = line.replace(allDayMatch[0], "").trim();
        } else if (halfDayMatch) { 
           if (halfDayMatch[0].includes('ä¸Š')) { startH = 9; endH = 12; } else { startH = 13; endH = 17; }
           foundTime = true;
           line = line.replace(halfDayMatch[0], "").trim();
        }
      }

      // 2. æ‰¾åœ°é»/æ¨™é¡Œ
      if (line.length > 0 && !line.match(/^[æ—¥ä¸€äºŒä¸‰å››äº”å…­]$/)) {
         if (line.includes("åœ°é»") || line.includes("å®¤")) {
            location = (location + " " + line).trim();
         } else {
            title = (title + " " + line).trim();
         }
      }
    });

    if (!title) title = "æœªå‘½åè¡Œç¨‹";

    // æ§‹å»ºç‰©ä»¶
    const startObj = new Date(\`\${group.date}T\${String(startH).padStart(2,'0')}:\${String(startM).padStart(2,'0')}:00\`);
    const endObj = new Date(\`\${group.date}T\${String(endH).padStart(2,'0')}:\${String(endM).padStart(2,'0')}:00\`);
    
    // åˆ†é…é€£çµ
    let assignedLink = "";
    if (links.length > 0) {
        if (links.length === 1) assignedLink = links[0];
        else if (linkIndex < links.length) assignedLink = links[linkIndex++];
        else assignedLink = links[links.length - 1]; 
    }

    results.push({
      date: group.date,
      timeStart: \`\${String(startH).padStart(2,'0')}:\${String(startM).padStart(2,'0')}\`,
      timeEnd: \`\${String(endH).padStart(2,'0')}:\${String(endM).padStart(2,'0')}\`,
      startObj: startObj,
      endObj: endObj,
      title: title,
      location: location || assignedLink
    });
  });

  return { status: 'success', data: results };
}

function createCalendarEvent(data) {
  CalendarApp.getCalendarById(CALENDAR_ID).createEvent(data.title, data.startObj, data.endObj, { description: \`åœ°é»/é€£çµ: \${data.location}\\n(æ™‚å…‰ç§˜æ›¸)\`, location: data.location });
}

function checkReminders() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return;
  const now = new Date();
  if (now.getHours() === 4 && now.getMinutes() < 15) { performDailyMaintenance(ss, sheet); }
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  const maxReminderMin = Math.max(...REMINDER_OFFSETS);
  const maxLookAheadTime = new Date(now.getTime() + (maxReminderMin + 60) * 60 * 1000); 
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const userId = row[0];
    const eventTime = new Date(row[4]); 
    const title = row[5];
    const location = row[6];
    let notifiedStatus = row[7] ? String(row[7]) : ""; 
    if (eventTime > maxLookAheadTime) { break; }
    let needUpdate = false;
    REMINDER_OFFSETS.forEach(offsetMin => {
      if (notifiedStatus.includes(\`|\${offsetMin}|\`)) return;
      const timeDiffMin = (eventTime.getTime() - now.getTime()) / 60000;
      if (timeDiffMin <= offsetMin && timeDiffMin > (offsetMin - 20)) {
        let timeLabel = "";
        if (offsetMin >= 1440) timeLabel = \`å‰ \${Math.floor(offsetMin/1440)} å¤©\`;
        else if (offsetMin >= 60) timeLabel = \`å‰ \${(offsetMin/60).toFixed(1).replace('.0','')} å°æ™‚\`;
        else timeLabel = \`å‰ \${offsetMin} åˆ†é˜\`;
        const msg = \`â° æé†’ (\${timeLabel})ï¼šæ´»å‹•å³å°‡é–‹å§‹ï¼\\n\\nä¸»é¡Œï¼š\${title}\\næ™‚é–“ï¼š\${Utilities.formatDate(eventTime, Session.getScriptTimeZone(), "HH:mm")}\\nåœ°é»/é€£çµï¼š\${location}\`;
        pushLineMessage(userId, msg);
        notifiedStatus += \`|\${offsetMin}|\`;
        needUpdate = true;
      }
    });
    if (needUpdate) { sheet.getRange(i + 1, 8).setValue(notifiedStatus); }
  }
}

function performDailyMaintenance(ss, sheet) {
  let historySheet = ss.getSheetByName(HISTORY_SHEET_NAME);
  if (!historySheet) { historySheet = ss.insertSheet(HISTORY_SHEET_NAME).appendRow(["LineUserID", "æ—¥æœŸ", "é–‹å§‹æ™‚é–“", "çµæŸæ™‚é–“", "å®Œæ•´é–‹å§‹æ™‚é–“", "ä¸»é¡Œ", "åœ°é»/é€£çµ", "æé†’ç‹€æ…‹", "å°å­˜æ™‚é–“"]); }
  const values = sheet.getDataRange().getValues();
  const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
  for (let i = values.length - 1; i >= 1; i--) {
    const eventTime = new Date(values[i][4]);
    if (eventTime < yesterday) {
      historySheet.appendRow([...values[i], new Date()]);
      sheet.deleteRow(i + 1);
    }
  }
}

function replyLine(replyToken, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post', 'payload': JSON.stringify({ replyToken: replyToken, messages: [{ type: 'text', text: text }] })
  });
}
function pushLineMessage(userId, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/push', {
    'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'method': 'post', 'payload': JSON.stringify({ to: userId, messages: [{ type: 'text', text: text }] })
  });
}
`;

        function generateCode() {
            const token = document.getElementById('inputToken').value.trim();
            const sheetId = document.getElementById('inputSheetId').value.trim();
            
            let reminders = [60]; 
            const r1Val = document.getElementById('rem1_val').value;
            const r1Unit = document.getElementById('rem1_unit').value;
            if (r1Val && !isNaN(r1Val) && parseInt(r1Val) > 0) { reminders.push(parseInt(r1Val) * parseInt(r1Unit)); }
            const r2Val = document.getElementById('rem2_val').value;
            const r2Unit = document.getElementById('rem2_unit').value;
            if (r2Val && !isNaN(r2Val) && parseInt(r2Val) > 0) { reminders.push(parseInt(r2Val) * parseInt(r2Unit)); }
            reminders = [...new Set(reminders)].sort((a,b) => a - b);
            const reminderArrayStr = JSON.stringify(reminders);

            if (!token || !sheetId) { alert("è«‹å…ˆè¼¸å…¥ LINE Token èˆ‡ Google Sheet ID å–”ï¼"); return; }

            let finalCode = gasTemplate.replace('{{TOKEN}}', token).replace('{{SHEET_ID}}', sheetId).replace('{{REMINDER_ARRAY}}', reminderArrayStr);
            const outputArea = document.getElementById('outputCode');
            outputArea.value = finalCode;
            const resultSection = document.getElementById('resultSection');
            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('copyStatus').classList.add('hidden');
        }

        function copyCode() {
            const outputArea = document.getElementById('outputCode');
            outputArea.select();
            document.execCommand('copy');
            const status = document.getElementById('copyStatus');
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>